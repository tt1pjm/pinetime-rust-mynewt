<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Bluetooth Time Sync, Rust Watch Faces and LVGL on PineTime Mynewt</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Bluetooth Time Sync, Rust Watch Faces and LVGL on PineTime Mynewt" 
    data-rh="true">
<meta property="og:description" 
    content="How PineTime syncs the time over Bluetooth LE... And how we build PineTime Watch Faces with Rust and LVGL" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/timesync-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Bluetooth Time Sync, Rust Watch Faces and LVGL on PineTime Mynewt</h1>
    <nav id="TOC"><ul>
<li><a href="#time-sync-over-bluetooth-le">1 Time Sync over Bluetooth LE</a><ul></ul></li>
<li><a href="#get-the-time-in-c">2 Get the Time in C</a><ul></ul></li>
<li><a href="#get-the-time-in-rust">3 Get the Time in Rust</a><ul></ul></li>
<li><a href="#watch-face-in-c">4 Watch Face in C</a><ul></ul></li>
<li><a href="#watch-face-in-rust">5 Watch Face in Rust</a><ul></ul></li>
<li><a href="#porting-lvgl-to-mynewt">6 Porting LVGL to Mynewt</a><ul></ul></li>
<li><a href="#rust-wrapper-for-lvgl">7 Rust Wrapper for LVGL</a><ul></ul></li>
<li><a href="#whats-next">8 What's Next</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/timesync-title.png" alt="PineTime Smart Watch with Bluetooth Time Sync and Rust Watch Face" /></p>
<p>Let's learn how PineTime syncs the time over Bluetooth LE... And how we build PineTime Watch Faces with Rust and LVGL.</p>
<h1 id="time-sync-over-bluetooth-le" class="section-header"><a href="#time-sync-over-bluetooth-le">1 Time Sync over Bluetooth LE</a></h1>
<p>TODO: Bluetooth LE Current Time Service, Discovering Bluetooth LE Services and Characteristics, Reading Bluetooth LE Characteristics, Decoding Bluetooth LE Current Time</p>
<p>When a peer is connected, discover the services exposed by the peer: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/apps/my_sensor_app/src/ble_main.c"><code>apps/my_sensor_app/src/ble_main.c</code></a></p>
<pre><code class="language-c">/**
 * The nimble host executes this callback when a GAP event occurs.  The
 * application associates a GAP event callback with each connection that forms.
 * bleprph uses the same callback for all connections. */
static int bleprph_gap_event(struct ble_gap_event *event, void *arg) {
    struct ble_gap_conn_desc desc;
    int rc;

    switch (event-&gt;type) {
    case BLE_GAP_EVENT_CONNECT:
        /* A new connection was established or a connection attempt failed. */
        MODLOG_DFLT_INFO(&quot;connection %s; status=%d &quot;,
                    event-&gt;connect.status == 0 ? &quot;established&quot; : &quot;failed&quot;,
                    event-&gt;connect.status);
        if (event-&gt;connect.status == 0) {
            rc = ble_gap_conn_find(event-&gt;connect.conn_handle, &amp;desc);
            assert(rc == 0);
            bleprph_print_conn_desc(&amp;desc);

#if MYNEWT_VAL(BLEPRPH_LE_PHY_SUPPORT)
            phy_conn_changed(event-&gt;connect.conn_handle);
#endif

            //  When a BLE connection is established, we read the GATT Characteristic of the Current Time Service of the BLE Peer
            //  Based on https://github.com/apache/mynewt-nimble/blob/master/apps/blecent/src/main.c

            //  Remember the BLE Peer. Ignore the error if we have already added the peer.
            rc = blepeer_add(event-&gt;connect.conn_handle);
            if (rc != 0 &amp;&amp; rc != 2) { MODLOG_DFLT_ERROR(&quot;Failed to add peer: %d\n&quot;, rc); MODLOG_DFLT_FLUSH(); }
            else {
                //  Discover all GATT Sevices in BLE Peer (including Current Time Service)
                rc = blepeer_disc_all(event-&gt;connect.conn_handle, blecent_on_disc_complete, NULL);
                if (rc != 0) { MODLOG_DFLT_ERROR(&quot;Failed to discover services: %d\n&quot;, rc); MODLOG_DFLT_FLUSH(); }
            }
        }
</code></pre>
<p>Time Sync. When a BLE connection is established, we read the GATT Characteristic for the Current Time Service of the BLE Peer</p>
<p>Based on https://github.com/apache/mynewt-nimble/blob/master/apps/blecent/src/main.c</p>
<pre><code class="language-c">#define BLE_GATT_SVC_CTS        (0x1805)  //  GATT Service for Current Time Service
#define BLE_GATT_CHR_CUR_TIME   (0x2A2B)  //  GATT Characteristic for Current Time
</code></pre>
<p>When services has been discovered...</p>
<pre><code class="language-c">/// Called when GATT Service Discovery of the BLE Peer has completed
static void blecent_on_disc_complete(const struct blepeer *peer, int status, void *arg) {
    if (status != 0) {
        //  Service discovery failed
        MODLOG_DFLT_ERROR(&quot;Error: Service discovery failed; status=%d conn_handle=%d\n&quot;, status, peer-&gt;conn_handle);
        goto err;
    }

    //  GATT Service Discovery has completed successfully.  Now we have a complete list of services, characteristics, and descriptors that the peer supports.
    MODLOG_DFLT_INFO(&quot;Service discovery complete; status=%d conn_handle=%d\n&quot;, status, peer-&gt;conn_handle);

    //  Read the GATT Characteristics from the peer
    blecent_read(peer);
    return;

err:
    //  Don't terminate the BLE connection yet, may be used by MCU Manager
    //  ble_gap_terminate(peer-&gt;conn_handle, BLE_ERR_REM_USER_CONN_TERM);
    return;
}

Read the Current Time Characteristic...

```c
/// Read the GATT Characteristic for Current Time from the BLE Peer
static void blecent_read(const struct blepeer *peer) {
    //  Find the GATT Characteristic for Current Time Service from the discovered GATT Characteristics
    const struct blepeer_chr *chr = blepeer_chr_find_uuid(
        peer,
        BLE_UUID16_DECLARE(BLE_GATT_SVC_CTS),      //  GATT Service for Current Time Service
        BLE_UUID16_DECLARE(BLE_GATT_CHR_CUR_TIME)  //  GATT Characteristic for Current Time Service
    );
    if (chr == NULL) {
        MODLOG_DFLT_ERROR(&quot;Error: Peer doesn't support CTS\n&quot;);
        goto err;
    }

    //  Read the Current Time Service Characteristic
    int rc = ble_gattc_read(
        peer-&gt;conn_handle,      //  BLE Connection
        chr-&gt;chr.val_handle,    //  GATT Characteristic
        blecent_on_read,        //  Callback after reading
        NULL                    //  Callback argument
    );
    if (rc != 0) {
        MODLOG_DFLT(ERROR, &quot;Error: Can't read CTS: %d\n&quot;, rc);
        goto err;
    }
    return;

err:
    //  Don't terminate the BLE connection yet, may be used by MCU Manager
    //  ble_gap_terminate(peer-&gt;conn_handle, BLE_ERR_REM_USER_CONN_TERM);
    return;
}
</code></pre>
<p>When the Current Time Characteristic has been read...</p>
<pre><code class="language-c">/// Called when Current Time GATT Characteristic has been read
static int blecent_on_read(uint16_t conn_handle, const struct ble_gatt_error *error, struct ble_gatt_attr *attr, void *arg) {
    //  Read the current time from the GATT Characteristic
    MODLOG_DFLT_INFO(&quot;Read complete; status=%d conn_handle=%d&quot;, error-&gt;status, conn_handle);
    if (error-&gt;status == 0) {
        MODLOG_DFLT_INFO(&quot; attr_handle=%d value=&quot;, attr-&gt;handle);
        print_mbuf(attr-&gt;om);
    }
    MODLOG_DFLT_INFO(&quot;\n&quot;);

    //  Set the system time from the current time
    int rc = set_system_time(attr-&gt;om);
    if (rc != 0) {
        MODLOG_DFLT_ERROR(&quot;Error: Can't set time: %d\n&quot;, rc);
        goto err;
    }

    //  Get the system time
    struct os_timeval tv;
    struct os_timezone tz;
    rc = os_gettimeofday(&amp;tv, &amp;tz);
    if (rc != 0) { MODLOG_DFLT_ERROR(&quot;Error: Can't get time: %d\n&quot;, rc); goto err; }
    struct clocktime ct;
    rc = timeval_to_clocktime(&amp;tv, &amp;tz, &amp;ct);
    if (rc != 0) { MODLOG_DFLT_ERROR(&quot;Error: Can't convert time: %d\n&quot;, rc); goto err; }

    //  Dump the system time as 2020-10-04T13:20:26.839843+00:00
    char buf[50];
    rc = datetime_format(&amp;tv, &amp;tz, buf, sizeof(buf));
    if (rc != 0) { MODLOG_DFLT_ERROR(&quot;Error: Can't format time: %d\n&quot;, rc); goto err; }
    console_printf(&quot;Current Time: %s\n&quot;, buf);

    //  TODO: Update the current time periodically
    return 0;

err:
    return 0;  //  Don't propagate error to system
}
</code></pre>
<p>Data Format for Current Time...</p>
<pre><code class="language-c">/// Data Format for Current Time Service. Based on https://github.com/sdalu/mynewt-nimble/blob/495ff291a15306787859a2fe8f2cc8765b546e02/nimble/host/services/cts/src/ble_svc_cts.c
struct ble_current_time {
    uint16_t year;
    uint8_t month;
    uint8_t day;
    uint8_t hours;
    uint8_t minutes;
    uint8_t secondes;
    uint8_t day_of_week;
    uint8_t fraction256;
    uint8_t adjust_reason;
} __attribute__((__packed__));
</code></pre>
<p>Set the Mynewt system time...</p>
<pre><code class="language-c">/// Set system time given the GATT Current Time in Mbuf format. Based on https://github.com/sdalu/mynewt-nimble/blob/495ff291a15306787859a2fe8f2cc8765b546e02/nimble/host/services/cts/src/ble_svc_cts.c
static int set_system_time(const struct os_mbuf *om) {
    //  Verify the Mbuf size
    uint16_t om_len = OS_MBUF_PKTLEN(om);
    if (om_len != sizeof(struct ble_current_time)) {  //  Should be 10 bytes
        return BLE_ATT_ERR_INVALID_ATTR_VALUE_LEN;
    }

    //  Copy the data from the Mbuf
    struct ble_current_time current_time;
    int rc = ble_hs_mbuf_to_flat(  //  Flatten and copy the Mbuf...
        om,                        //  From om...
		&amp;current_time,             //  To current_time...
        om_len,                    //  For om_len bytes
        NULL
    );
    if (rc != 0) { return BLE_ATT_ERR_UNLIKELY; }

    //  Get timezone
    struct os_timeval tv0;
    struct os_timezone tz;
    rc = os_gettimeofday(&amp;tv0, &amp;tz);
    if (rc != 0) { return BLE_ATT_ERR_UNLIKELY; }

    //  Convert to clocktime format
    struct clocktime ct;
    ct.year = le16toh(current_time.year);
    ct.mon  = current_time.month;
    ct.day  = current_time.day;
    ct.hour = current_time.hours;
    ct.min  = current_time.minutes;
    ct.sec  = current_time.secondes;
    ct.usec = (current_time.fraction256 * 1000000) / 256;

    //  Convert to timeval format
    struct os_timeval tv;    
    rc = clocktime_to_timeval(&amp;ct, &amp;tz, &amp;tv);
    if (rc != 0) { return BLE_ATT_ERR_UNLIKELY; }

    //  Set the system time
    rc = os_settimeofday(&amp;tv, NULL);
    if (rc != 0) { return BLE_ATT_ERR_UNLIKELY; }
    return 0;
}
</code></pre>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/apps/my_sensor_app/src/ble_peer.c"><code>apps/my_sensor_app/src/ble_peer.c</code></a></p>
<p>Bluetooth Log:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Starting</span> <span class="ident">BLE</span>...
<span class="ident">BLE</span> <span class="ident">started</span>
<span class="ident">Render</span> <span class="ident">LVGL</span> <span class="ident">display</span>...
<span class="ident">Flush</span> <span class="ident">display</span>: <span class="ident">left</span><span class="op">=</span><span class="number">63</span>, <span class="ident">top</span><span class="op">=</span><span class="number">27</span>, <span class="ident">right</span><span class="op">=</span><span class="number">196</span>, <span class="ident">bottom</span><span class="op">=</span><span class="number">42</span>...
<span class="ident">connection</span> <span class="ident">established</span>;
<span class="ident">connection</span> <span class="ident">updated</span>; 
<span class="ident">Service</span> <span class="ident">discovery</span> <span class="ident">complete</span>; <span class="ident">status</span><span class="op">=</span><span class="number">0</span> <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span>
<span class="ident">Read</span> <span class="ident">complete</span>; <span class="ident">status</span><span class="op">=</span><span class="number">0</span> <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">67</span> <span class="ident">value</span><span class="op">=</span><span class="ident">e4</span> <span class="number">07</span> <span class="number">0a</span> <span class="number">04</span> <span class="number">0e</span> <span class="number">05</span> <span class="number">29</span> <span class="number">07</span> <span class="number">87</span> <span class="number">00</span> 
<span class="ident">Current</span> <span class="ident">Time</span>: <span class="number">2020</span><span class="op">-</span><span class="number">10</span><span class="op">-</span><span class="number">04T14</span>:<span class="number">05</span>:<span class="number">41.527343</span><span class="op">+</span><span class="number">00</span>:<span class="number">00</span>
...
<span class="ident">Render</span> <span class="ident">LVGL</span> <span class="ident">display</span>...
<span class="ident">Flush</span> <span class="ident">display</span>: <span class="ident">left</span><span class="op">=</span><span class="number">60</span>, <span class="ident">top</span><span class="op">=</span><span class="number">27</span>, <span class="ident">right</span><span class="op">=</span><span class="number">183</span>, <span class="ident">bottom</span><span class="op">=</span><span class="number">42</span>...
...
<span class="ident">Render</span> <span class="ident">LVGL</span> <span class="ident">display</span>...
<span class="ident">Flush</span> <span class="ident">display</span>: <span class="ident">left</span><span class="op">=</span><span class="number">59</span>, <span class="ident">top</span><span class="op">=</span><span class="number">27</span>, <span class="ident">right</span><span class="op">=</span><span class="number">181</span>, <span class="ident">bottom</span><span class="op">=</span><span class="number">42</span>...
...
<span class="ident">Render</span> <span class="ident">LVGL</span> <span class="ident">display</span>...
<span class="ident">Flush</span> <span class="ident">display</span>: <span class="ident">left</span><span class="op">=</span><span class="number">59</span>, <span class="ident">top</span><span class="op">=</span><span class="number">27</span>, <span class="ident">right</span><span class="op">=</span><span class="number">180</span>, <span class="ident">bottom</span><span class="op">=</span><span class="number">42</span>...</pre></div>
<h1 id="get-the-time-in-c" class="section-header"><a href="#get-the-time-in-c">2 Get the Time in C</a></h1>
<p>TODO: os_timeval, clocktime and ISO format, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/apps/my_sensor_app/src/watch_face.c"><code>my_sensor_app/src/watch_face.c</code></a></p>
<pre><code class="language-c">//  Get the system time
struct os_timeval tv;
struct os_timezone tz;
int rc = os_gettimeofday(&amp;tv, &amp;tz);
if (rc != 0) { console_printf(&quot;Can't get time: %d\n&quot;, rc); return 2; }

//  Convert the time
struct clocktime ct;
rc = timeval_to_clocktime(&amp;tv, &amp;tz, &amp;ct);
if (rc != 0) { console_printf(&quot;Can't convert time: %d\n&quot;, rc); return 3; }

//  Format the time as 2020-10-04T13:20:26.839843+00:00
char buf[50];
rc = datetime_format(&amp;tv, &amp;tz, buf, sizeof(buf));
if (rc != 0) { console_printf(&quot;Can't format time: %d\n&quot;, rc); return 4; }

//  Truncate after minute: 2020-10-04T13:20
buf[16] = 0;
</code></pre>
<h1 id="get-the-time-in-rust" class="section-header"><a href="#get-the-time-in-rust">3 Get the Time in Rust</a></h1>
<p>TODO: WatchFaceTime, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/watch_face.rs"><code>rust/app/src/watch_face.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Get the system time</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">get_system_time</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span><span class="ident">WatchFaceTime</span><span class="op">&gt;</span> {
    <span class="comment">//  Get the system time</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">TV</span>: <span class="ident">os</span>::<span class="ident">os_timeval</span>  <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">os</span>::<span class="ident">os_timeval</span>);
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">TZ</span>: <span class="ident">os</span>::<span class="ident">os_timezone</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">os</span>::<span class="ident">os_timezone</span>);
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">os</span>::<span class="ident">os_gettimeofday</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">TV</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">TZ</span>) };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Can&#39;t get time&quot;</span>);    

    <span class="comment">//  Convert the time</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">CT</span>: <span class="ident">clocktime</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">clocktime</span>);
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">timeval_to_clocktime</span>(<span class="kw-2">&amp;</span><span class="ident">TV</span>, <span class="kw-2">&amp;</span><span class="ident">TZ</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">CT</span>) };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Can&#39;t convert time&quot;</span>);

    <span class="comment">//  Return the time</span>
    <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because CT is a mutable static</span>
        <span class="ident">WatchFaceTime</span> {
            <span class="ident">year</span>:       <span class="ident">CT</span>.<span class="ident">year</span> <span class="kw">as</span> <span class="ident">u16</span>,  <span class="comment">//  Year (4 digit year)</span>
            <span class="ident">month</span>:      <span class="ident">CT</span>.<span class="ident">mon</span>  <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Month (1 - 12)</span>
            <span class="ident">dayofmonth</span>: <span class="ident">CT</span>.<span class="ident">day</span>  <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Day (1 - 31)</span>
            <span class="ident">hour</span>:       <span class="ident">CT</span>.<span class="ident">hour</span> <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Hour (0 - 23)</span>
            <span class="ident">minute</span>:     <span class="ident">CT</span>.<span class="ident">min</span>  <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Minute (0 - 59)</span>
            <span class="ident">second</span>:     <span class="ident">CT</span>.<span class="ident">sec</span>  <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Second (0 - 59)</span>
            <span class="ident">fracs</span>:      <span class="number">0</span>,               <span class="comment">//  Unused</span>
            <span class="ident">dayofweek</span>:  <span class="ident">CT</span>.<span class="ident">dow</span>  <span class="kw">as</span> <span class="ident">u8</span>,   <span class="comment">//  Day of week (0 - 6; 0 = Sunday)</span>
        }
    };
    <span class="prelude-val">Ok</span>(<span class="ident">result</span>)
}</pre></div>
<h1 id="watch-face-in-c" class="section-header"><a href="#watch-face-in-c">4 Watch Face in C</a></h1>
<p>TODO: Mynewt timer, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/apps/my_sensor_app/src/watch_face.c"><code>my_sensor_app/src/watch_face.c</code></a></p>
<p>Create the watch face...</p>
<pre><code class="language-c">/// Render a watch face. Called by main() in rust/app/src/lib.rs
int create_watch_face(void) {
    console_printf(&quot;Create watch face...\n&quot;); console_flush();
    btn = lv_btn_create(lv_scr_act(), NULL);     //  Add a button the current screen
    lv_obj_set_pos(btn, 10, 10);                 //  Set its position
    lv_obj_set_size(btn, 220, 50);               //  Set its size

    label = lv_label_create(btn, NULL);          //  Add a label to the button
    lv_label_set_text(label, &quot;Time Sync&quot;);       //  Set the label text

    //  Set a timer to update the watch face every minute
    //  TODO: Move this code to the caller
    os_callout_init(
        &amp;watch_face_callout,   //  Timer for the watch face
        os_eventq_dflt_get(),  //  Use default event queue
        watch_face_callback,   //  Callback function for the timer
        NULL
    );
    //  Trigger the timer in 60 seconds
    os_callout_reset(
        &amp;watch_face_callout,   //  Timer for the watch face
        OS_TICKS_PER_SEC * 60  //  Trigger timer in 60 seconds
    );
    return 0;
}
</code></pre>
<p>Update the watch face...</p>
<pre><code class="language-c">/// Update the watch face
int update_watch_face(void) {
    //  If button or label not created, quit
    if (btn == NULL || label == NULL) { return 1; }

    //  Get the system time
    struct os_timeval tv;
    struct os_timezone tz;
    int rc = os_gettimeofday(&amp;tv, &amp;tz);
    if (rc != 0) { console_printf(&quot;Can't get time: %d\n&quot;, rc); return 2; }

    //  Convert the time
    struct clocktime ct;
    rc = timeval_to_clocktime(&amp;tv, &amp;tz, &amp;ct);
    if (rc != 0) { console_printf(&quot;Can't convert time: %d\n&quot;, rc); return 3; }

    //  Format the time as 2020-10-04T13:20:26.839843+00:00
    char buf[50];
    rc = datetime_format(&amp;tv, &amp;tz, buf, sizeof(buf));
    if (rc != 0) { console_printf(&quot;Can't format time: %d\n&quot;, rc); return 4; }

    //  Truncate after minute: 2020-10-04T13:20
    buf[16] = 0;

    //  Set the label text
    lv_label_set_text(label, buf);
    return 0;
}
</code></pre>
<p>Callback every minute...</p>
<pre><code class="language-c">/// Timer callback that is called every minute
static void watch_face_callback(struct os_event *ev) {
    assert(ev != NULL);

    //  Update the watch face
    update_watch_face();

    //  Render the watch face
    pinetime_lvgl_mynewt_render();

    //  Set the watch face timer
    os_callout_reset(
        &amp;watch_face_callout,   //  Timer for the watch face
        OS_TICKS_PER_SEC * 60  //  Trigger timer in 60 seconds
    );
}
</code></pre>
<h1 id="watch-face-in-rust" class="section-header"><a href="#watch-face-in-rust">5 Watch Face in Rust</a></h1>
<p>TODO: Barebones watch face, LVGL styles, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/watch_face.rs"><code>rust/app/src/watch_face.rs</code></a></p>
<p>Start the watch face...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Start rendering the watch face every minute</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">start_watch_face</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="ident">console</span>::<span class="ident">print</span>(<span class="string">&quot;Init Rust watch face...\n&quot;</span>); <span class="ident">console</span>::<span class="ident">flush</span>();

    <span class="comment">//  Get active screen from LVGL. We can&#39;t call lv_scr_act() because it&#39;s an inline function.</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because WATCH_FACE_WIDGETS is a mutable static</span>
        <span class="ident">WATCH_FACE_WIDGETS</span>.<span class="ident">screen</span> <span class="op">=</span> <span class="ident">lv_disp_get_scr_act</span>( 
            <span class="ident">obj</span>::<span class="ident">disp_get_default</span>()
                .<span class="ident">expect</span>(<span class="string">&quot;Failed to get display&quot;</span>)
        );
    }

    <span class="comment">//  Create the watch face    </span>
    <span class="ident">create_widgets</span>(<span class="kw">unsafe</span> { <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_WIDGETS</span> }) <span class="question-mark">?</span> ;

    <span class="comment">//  Render the watch face</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">pinetime_lvgl_mynewt_render</span>() };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;LVGL render fail&quot;</span>);    

    <span class="comment">//  Set a timer to update the watch face every minute</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_init is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_init</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,         <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">eventq_dflt_get</span>().<span class="ident">unwrap</span>(),  <span class="comment">//  Use default event queue</span>
            <span class="prelude-val">Some</span>(<span class="ident">watch_face_callback</span>),       <span class="comment">//  Callback function for the timer</span>
            <span class="ident">ptr</span>::<span class="ident">null_mut</span>()                  <span class="comment">//  No argument</span>
        );    
    }

    <span class="comment">//  Trigger the watch face timer in 60 seconds</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_reset is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_reset</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,   <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">OS_TICKS_PER_SEC</span> <span class="op">*</span> <span class="number">60</span>  <span class="comment">//  Trigger timer in 60 seconds</span>
        )
    };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Timer fail&quot;</span>);
    <span class="prelude-val">Ok</span>(())
}</pre></div>
<p>Create the widgets...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Create the widgets for the Watch Face. Called by start_watch_face() below.</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">create_widgets</span>(<span class="ident">widgets</span>: <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WatchFaceWidgets</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">//  Fetch the screen, which will be the parent of the widgets</span>
    <span class="kw">let</span> <span class="ident">scr</span> <span class="op">=</span> <span class="ident">widgets</span>.<span class="ident">screen</span>;
    <span class="macro">assert</span><span class="macro">!</span>(<span class="op">!</span><span class="ident">scr</span>.<span class="ident">is_null</span>(), <span class="string">&quot;null screen&quot;</span>);

    <span class="comment">//  Create a label for Time: &quot;00:00&quot;</span>
    <span class="ident">widgets</span>.<span class="ident">time_label</span> <span class="op">=</span> {
        <span class="kw">let</span> <span class="ident">lbl</span> <span class="op">=</span> <span class="ident">label</span>::<span class="ident">create</span>(<span class="ident">scr</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;  <span class="comment">//  `?` will terminate the function in case of error</span>
        <span class="ident">label</span>::<span class="ident">set_long_mode</span>(<span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_LONG_BREAK</span>) <span class="question-mark">?</span> ;
        <span class="ident">label</span>::<span class="ident">set_text</span>(     <span class="ident">lbl</span>, <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;00:00&quot;</span>)) <span class="question-mark">?</span> ;  <span class="comment">//  strn creates a null-terminated string</span>
        <span class="ident">obj</span>::<span class="ident">set_width</span>(      <span class="ident">lbl</span>, <span class="number">240</span>) <span class="question-mark">?</span> ;
        <span class="ident">obj</span>::<span class="ident">set_height</span>(     <span class="ident">lbl</span>, <span class="number">200</span>) <span class="question-mark">?</span> ;
        <span class="ident">label</span>::<span class="ident">set_align</span>(    <span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_ALIGN_CENTER</span>) <span class="question-mark">?</span> ;
        <span class="ident">obj</span>::<span class="ident">align</span>(          <span class="ident">lbl</span>, <span class="ident">scr</span>, <span class="ident">obj</span>::<span class="ident">LV_ALIGN_CENTER</span>, <span class="number">0</span>, <span class="op">-</span><span class="number">30</span>) <span class="question-mark">?</span> ;    
        <span class="ident">lbl</span>
    };</pre></div>
<p>Callback every minute...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Timer callback that is called every minute</span>
<span class="kw">extern</span> <span class="kw">fn</span> <span class="ident">watch_face_callback</span>(<span class="ident">_ev</span>: <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">os</span>::<span class="ident">os_event</span>) {
    <span class="ident">console</span>::<span class="ident">print</span>(<span class="string">&quot;Update Rust watch face...\n&quot;</span>); <span class="ident">console</span>::<span class="ident">flush</span>();

    <span class="comment">//  Get the system time    </span>
    <span class="kw">let</span> <span class="ident">time</span> <span class="op">=</span> <span class="ident">get_system_time</span>()
        .<span class="ident">expect</span>(<span class="string">&quot;Can&#39;t get system time&quot;</span>);

    <span class="comment">//  Compose the watch face state</span>
    <span class="kw">let</span> <span class="ident">state</span> <span class="op">=</span> <span class="ident">WatchFaceState</span> {
        <span class="ident">time</span>,
        <span class="ident">millivolts</span>: <span class="number">0</span>,     <span class="comment">//  TODO: Get current voltage</span>
        <span class="ident">charging</span>:   <span class="bool-val">true</span>,  <span class="comment">//  TODO: Get charging status</span>
        <span class="ident">powered</span>:    <span class="bool-val">true</span>,  <span class="comment">//  TODO: Get powered status</span>
        <span class="ident">ble_state</span>:  <span class="ident">BleState</span>::<span class="ident">BLEMAN_BLE_STATE_CONNECTED</span>,  <span class="comment">//  TODO: Get BLE state</span>
    };

    <span class="comment">//  Update the watch face</span>
    <span class="ident">update_widgets</span>(<span class="kw">unsafe</span> { <span class="kw-2">&amp;</span><span class="ident">WATCH_FACE_WIDGETS</span> }, <span class="kw-2">&amp;</span><span class="ident">state</span>)
        .<span class="ident">expect</span>(<span class="string">&quot;Update Watch Face fail&quot;</span>);

    <span class="comment">//  Render the watch face</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">pinetime_lvgl_mynewt_render</span>() };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;LVGL render fail&quot;</span>);    

    <span class="comment">//  Trigger the watch face timer in 60 seconds</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_reset is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_reset</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,   <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">OS_TICKS_PER_SEC</span> <span class="op">*</span> <span class="number">60</span>  <span class="comment">//  Trigger timer in 60 seconds</span>
        )
    };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Timer fail&quot;</span>);
}</pre></div>
<p>Update widgets...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Update the widgets in the Watch Face with the current state. Called by watch_face_callback() below.</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">update_widgets</span>(<span class="ident">widgets</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceWidgets</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">//  Populate the Time Label</span>
    <span class="ident">set_time_label</span>(<span class="ident">widgets</span>, <span class="ident">state</span>) <span class="question-mark">?</span> ;

    <span class="comment">//  Populate the Bluetooth Label</span>
    <span class="ident">set_bt_label</span>(<span class="ident">widgets</span>, <span class="ident">state</span>) <span class="question-mark">?</span> ;

    <span class="comment">//  Populate the Power Label</span>
    <span class="ident">set_power_label</span>(<span class="ident">widgets</span>, <span class="ident">state</span>) <span class="question-mark">?</span> ;
    <span class="prelude-val">Ok</span>(())
}</pre></div>
<p>Populate time and date widgets...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Populate the Time and Date Labels with the time and date. Called by update_widgets() above.</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">set_time_label</span>(<span class="ident">widgets</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceWidgets</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">//  Create a string buffer to format the time</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">TIME_BUF</span>: <span class="ident">String</span> <span class="op">=</span> <span class="ident">new_string</span>();
    <span class="comment">//  Format the time as &quot;12:34&quot; and set the label</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because TIME_BUF is a mutable static</span>
        <span class="ident">TIME_BUF</span>.<span class="ident">clear</span>();
        <span class="macro">write</span><span class="macro">!</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">TIME_BUF</span>, 
            <span class="string">&quot;{:02}:{:02}\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span>
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">hour</span>,
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">minute</span>
        ).<span class="ident">expect</span>(<span class="string">&quot;time fail&quot;</span>);
        <span class="ident">label</span>::<span class="ident">set_text</span>(
            <span class="ident">widgets</span>.<span class="ident">time_label</span>, 
            <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">TIME_BUF</span>)
        ) <span class="question-mark">?</span> ;
    }

    <span class="comment">//  Get the short month name</span>
    <span class="kw">let</span> <span class="ident">month_str</span> <span class="op">=</span> <span class="ident">get_month_name</span>(<span class="kw-2">&amp;</span><span class="ident">state</span>.<span class="ident">time</span>);

    <span class="comment">//  Create a string buffer to format the date</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">DATE_BUF</span>: <span class="ident">String</span> <span class="op">=</span> <span class="ident">new_string</span>();
    <span class="comment">//  Format the date as &quot;22 MAY 2020&quot; and set the label</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because DATE_BUF is a mutable static</span>
        <span class="ident">DATE_BUF</span>.<span class="ident">clear</span>();
        <span class="macro">write</span><span class="macro">!</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">DATE_BUF</span>, 
            <span class="string">&quot;{} {} {}\n\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span>
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">dayofmonth</span>,
            <span class="ident">month_str</span>,
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">year</span>
        ).<span class="ident">expect</span>(<span class="string">&quot;date fail&quot;</span>);
        <span class="ident">label</span>::<span class="ident">set_text</span>(
            <span class="ident">widgets</span>.<span class="ident">date_label</span>, 
            <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">DATE_BUF</span>)
        ) <span class="question-mark">?</span> ;
    }
    <span class="prelude-val">Ok</span>(())
}</pre></div>
<h1 id="porting-lvgl-to-mynewt" class="section-header"><a href="#porting-lvgl-to-mynewt">6 Porting LVGL to Mynewt</a></h1>
<p>TODO: SPI Driver for ST7789 Display Controller, <a href="https://gitlab.com/lupyuen/pinetime_lvgl_mynewt"><code>pinetime_lvgl_mynewt</code></a></p>
<p>Located at <code>libs/pinetime_lvgl_mynewt</code></p>
<p><a href="https://gitlab.com/lupyuen/pinetime_lvgl_mynewt/blob/master/src/pinetime/lvgl.c"><code>src/pinetime/lvgl.c</code></a></p>
<pre><code class="language-c">/// Init the LVGL library. Called by sysinit() during startup, defined in pkg.yml.
void pinetime_lvgl_mynewt_init(void) {    
    console_printf(&quot;Init LVGL...\n&quot;); console_flush();
    assert(pinetime_lvgl_mynewt_started == false);

    //  Init the display controller
    int rc = pinetime_lvgl_mynewt_init_display(); assert(rc == 0);

    //  Init the LVGL display
    lv_init();
    lv_port_disp_init();
    pinetime_lvgl_mynewt_started = true;
}

/// Render the LVGL display
int pinetime_lvgl_mynewt_render(void) {
    console_printf(&quot;Render LVGL display...\n&quot;); console_flush();
    //  Must tick at least 100 milliseconds to force LVGL to update display
    lv_tick_inc(100);
    //  LVGL will flush our display driver
    lv_task_handler();
    return 0;
}
</code></pre>
<p>Display Driver for ST7789: <a href="https://gitlab.com/lupyuen/pinetime_lvgl_mynewt/blob/master/src/pinetime/lv_port_disp.c"><code>src/pinetime/lv_port_disp.c</code></a></p>
<pre><code class="language-c">/// Flush the content of the internal buffer the specific area on the display
static void disp_flush(lv_disp_drv_t * disp_drv, const lv_area_t * area, lv_color_t * color_p) {
    //  Validate parameters
    assert(area-&gt;x2 &gt;= area-&gt;x1);
    assert(area-&gt;y2 &gt;= area-&gt;y1);

    //  Set the ST7789 display window
    pinetime_lvgl_mynewt_set_window(area-&gt;x1, area-&gt;y1, area-&gt;x2, area-&gt;y2);

    //  Write Pixels (RAMWR): st7735_lcd::draw() → set_pixel()
    int len = 
        ((area-&gt;x2 - area-&gt;x1) + 1) *  //  Width
        ((area-&gt;y2 - area-&gt;y1) + 1) *  //  Height
        2;                             //  2 bytes per pixel
    pinetime_lvgl_mynewt_write_command(RAMWR, NULL, 0);
    pinetime_lvgl_mynewt_write_data((const uint8_t *) color_p, len);

    //  IMPORTANT!!! Inform the graphics library that you are ready with the flushing
    lv_disp_flush_ready(disp_drv);
}
</code></pre>
<p><a href="https://gitlab.com/lupyuen/pinetime_lvgl_mynewt/blob/master/src/pinetime/display.c"><code>src/pinetime/display.c</code></a></p>
<pre><code class="language-c">/// Set the ST7789 display window to the coordinates (left, top), (right, bottom)
int pinetime_lvgl_mynewt_set_window(uint8_t left, uint8_t top, uint8_t right, uint8_t bottom) {
    assert(left &lt; COL_COUNT &amp;&amp; right &lt; COL_COUNT &amp;&amp; top &lt; ROW_COUNT &amp;&amp; bottom &lt; ROW_COUNT);
    assert(left &lt;= right);
    assert(top &lt;= bottom);
    //  Set Address Window Columns (CASET): st7735_lcd::draw() → set_pixel() → set_address_window()
    int rc = pinetime_lvgl_mynewt_write_command(CASET, NULL, 0); assert(rc == 0);
    uint8_t col_para[4] = { 0x00, left, 0x00, right };
    rc = pinetime_lvgl_mynewt_write_data(col_para, 4); assert(rc == 0);

    //  Set Address Window Rows (RASET): st7735_lcd::draw() → set_pixel() → set_address_window()
    rc = pinetime_lvgl_mynewt_write_command(RASET, NULL, 0); assert(rc == 0);
    uint8_t row_para[4] = { 0x00, top, 0x00, bottom };
    rc = pinetime_lvgl_mynewt_write_data(row_para, 4); assert(rc == 0);
    return 0;
}
</code></pre>
<pre><code class="language-c">/// Transmit ST7789 command
int pinetime_lvgl_mynewt_write_command(uint8_t command, const uint8_t *params, uint16_t len) {
    hal_gpio_write(DISPLAY_DC, 0);
    int rc = transmit_spi(&amp;command, 1);
    assert(rc == 0);
    if (params != NULL &amp;&amp; len &gt; 0) {
        rc = pinetime_lvgl_mynewt_write_data(params, len);
        assert(rc == 0);
    }
    return 0;
}

/// Transmit ST7789 data
int pinetime_lvgl_mynewt_write_data(const uint8_t *data, uint16_t len) {
    hal_gpio_write(DISPLAY_DC, 1);
    transmit_spi(data, len);
    return 0;
}
</code></pre>
<h1 id="rust-wrapper-for-lvgl" class="section-header"><a href="#rust-wrapper-for-lvgl">7 Rust Wrapper for LVGL</a></h1>
<p>TODO: Bindgen, Safe Wrapper Proc Macro, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/lvgl"><code>rust/lvgl</code></a></p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">8 What's Next</a></h1>
<p>TODO: Bluetooth Time Sync, Rust Watch Faces and LVGL were developed and tested with Remote PineTime</p>
<p><a href="https://lupyuen.github.io">Check out my PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>

    
</body>
</html>