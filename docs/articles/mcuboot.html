<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>MCUBoot Bootloader for PineTime Smart Watch (nRF52)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="MCUBoot Bootloader for PineTime Smart Watch (nRF52)" 
    data-rh="true">
<meta property="og:description" 
    content="Wireless Firmware Updates done right on PineTime Smart Watch... With the open source MCUBoot Bootloader from Apache Mynewt and Zephyr" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/mcuboot-photo2-small.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">MCUBoot Bootloader for PineTime Smart Watch (nRF52)</h1>
    <nav id="TOC"><ul>
<li><a href="#updated-flash-memory-map-for-pinetime">1 Updated Flash Memory Map for PineTime</a><ul></ul></li>
<li><a href="#blasting-graphics-to-st7789-display-controller-on-pinetime">2 Blasting Graphics to ST7789 Display Controller on PineTime</a><ul>
<li><a href="#initialise-the-display">2.1 Initialise The Display</a><ul></ul></li>
<li><a href="#draw-a-line">2.2 Draw A Line</a><ul></ul></li></ul></li>
<li><a href="#render-boot-graphic-from-spi-flash-on-pinetime">3 Render Boot Graphic from SPI Flash on PineTime</a><ul></ul></li>
<li><a href="#write-boot-graphic-to-spi-flash-on-pinetime">4 Write Boot Graphic to SPI Flash on PineTime</a><ul></ul></li>
<li><a href="#enable-custom-hooks-in-mcuboot">5 Enable Custom Hooks in MCUBoot</a><ul>
<li><a href="#enable-sysinit-hook">5.1 Enable <code>sysinit()</code> Hook</a><ul></ul></li>
<li><a href="#enable-boot_custom_start-hook">5.2 Enable <code>boot_custom_start()</code> Hook</a><ul></ul></li></ul></li>
<li><a href="#extend-mcuboot-with-pinetime-boot-library">6 Extend MCUBoot with PineTime Boot Library</a><ul>
<li><a href="#handle-mcuboot-sysinit-hook">6.1 Handle MCUBoot <code>sysinit()</code> Hook</a><ul></ul></li>
<li><a href="#handle-mcuboot-boot_custom_start-hook">6.2 Handle MCUBoot <code>boot_custom_start()</code> Hook</a><ul></ul></li></ul></li>
<li><a href="#manual-firmware-rollback-on-pinetime">7 Manual Firmware Rollback on PineTime</a><ul></ul></li>
<li><a href="#test-enhanced-mcuboot-bootloader-on-pinetime">8 Test Enhanced MCUBoot Bootloader on PineTime</a><ul></ul></li>
<li><a href="#more-enhancements-for-pinetime-bootloader">9 More Enhancements for PineTime Bootloader</a><ul></ul></li>
<li><a href="#bootloader-watchdog">10 Bootloader Watchdog</a><ul></ul></li>
<li><a href="#build-and-flash-mcuboot-bootloader">11 Build and Flash MCUBoot Bootloader</a><ul>
<li><a href="#install-build-tools">11.1 Install Build Tools</a><ul></ul></li>
<li><a href="#download-source-files">11.2 Download Source Files</a><ul></ul></li>
<li><a href="#build-mcuboot-bootloader">11.3 Build MCUBoot Bootloader</a><ul></ul></li>
<li><a href="#select-the-openocd-interface-st-link-or-raspberry-pi-spi">11.4 Select the OpenOCD Interface: ST-Link or Raspberry Pi SPI</a><ul></ul></li>
<li><a href="#flash-mcuboot-bootloader">11.5 Flash MCUBoot Bootloader</a><ul></ul></li>
<li><a href="#flash-application-firmware">11.6 Flash Application Firmware</a><ul></ul></li></ul></li>
<li><a href="#further-reading">12 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/mcuboot-photo2-small.jpg" alt="Enhanced MCUBoot Bootloader running on PineTime Smart Watch" /></p>
<p><em>Enhanced MCUBoot Bootloader running on PineTime Smart Watch</em></p>
<p>Today we'll talk about the <strong>Enhanced MCUBoot Bootloader</strong> for <a href="https://wiki.pine64.org/index.php/PineTime"><strong>PineTime Smart Watch</strong></a>. </p>
<p>Here's a sneak peek of the Enhanced MCUBoot Bootloader running on PineTime...</p>
<p><a href="https://twitter.com/MisterTechBlog/status/1261568945728876544?s=20">Watch video on Twitter</a></p>
<p><a href="https://qoto.org/@lupyuen/104177098953236703">Watch video on Mastodon</a></p>
<p>We'll learn how the open-source MCUBoot Bootloader (<a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">covered in an earlier article</a>) has been enhanced to support...</p>
<ol>
<li>
<p><strong>SPI Flash</strong> for storing the Standby Firmware Image</p>
</li>
<li>
<p><strong>Rendering the Boot Graphic</strong> that's stored in SPI Flash </p>
<p><em>(Because PineTime Owners should have the freedom to customise the way it looks!)</em></p>
</li>
<li>
<p><strong>Manual Firmware Rollback</strong> when the watch button is pressed during startup</p>
</li>
</ol>
<p><em>...Without making any code changes to MCUBoot! (Amazing!)</em></p>
<p>We'll see that the enhancements to MCUBoot were done through configuration files, and by adding some new functions.</p>
<p><em>Isn't it easier to fork MCUBoot and change the code?</em></p>
<p>We shall always resist the temptation to modify MCUBoot code... Because MCUBoot is a <strong>Critical and Secure</strong> part of PineTime!</p>
<ol>
<li>
<p>MCUBoot must <strong>not be allowed to crash or hang</strong> due to buggy code.</p>
<p>MCUBoot is the first thing that runs when PineTime starts up. If MCUBoot crashes or hangs, PineTime Owners will have a bricked watch on their wrists.</p>
</li>
<li>
<p>MCUBoot is designed to <strong>start firmware securely,</strong> protected by digital signatures.</p>
<p>Although we don't secure PineTime firmware today, MCUBoot may someday be used to verify that our firmware hasn't been tampered with.</p>
<p><em>(Because the data collected by our smart watches may be misused to harm us someday)</em></p>
</li>
</ol>
<h1 id="updated-flash-memory-map-for-pinetime" class="section-header"><a href="#updated-flash-memory-map-for-pinetime">1 Updated Flash Memory Map for PineTime</a></h1>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">If you haven't read the earlier article on MCUBoot... Please do so now!</a></p>
<p>Our earlier design for MCUBoot hit a showstopper... The Application Firmware size was limited to <strong>232 KB</strong>, which is too small acccording to PineTime Firmware Developers.</p>
<p>With Enhanced MCUBoot, we can now support firmware twice that size... Up to <strong>464 KB</strong>!  (Remember that PineTime's Flash ROM is only 512 KB)</p>
<p><em>How did we get so much ROM space?</em></p>
<p>We moved the Standby Firmware Image from PineTime's Flash ROM (512 KB) to PineTime's SPI Flash (4 MB).</p>
<p>During firmware update, the Standby Firmware slot is used as the staging area for the new firmware. On reboot, MCUBoot swaps the new firmware with the old firmware. If the new firmware doesn't start properly, MCUBoot swaps them back.</p>
<p>Here's the updated Flash Memory Map for PineTime. Note that the Standby Firmware Image is now stored in Flash Device 1 (SPI Flash) instead of Flash Device 0 (Internal ROM): <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/hw/bsp/nrf52/bsp.yml"><code>hw/bsp/nrf52/bsp.yml</code></a></p>
<pre><code class="language-yaml"># Flash Memory Map for PineTime: Internal Flash ROM and External SPI Flash
bsp.flash_map:
    areas:
        # System areas.
        FLASH_AREA_BOOTLOADER:       # MCUBoot
            device:  0               # Internal Flash ROM
            offset:  0x00000000      # Start of Internal Flash ROM
            size:    28kB
        FLASH_AREA_IMAGE_0:          # Active Firmware Image
            device:  0               # Internal Flash ROM
            offset:  0x00008000
            size:    464kB           # Max size of Firmware Image
        FLASH_AREA_IMAGE_1:          # Standby Firmware Image
            device:  1               # External SPI Flash
            offset:  0x00040000
            size:    464kB           # Max size of Firmware Image
        FLASH_AREA_IMAGE_SCRATCH:    # Used by MCUBoot for swapping Active and Standby Firmware
            device:  0               # Internal Flash ROM
            offset:  0x0007c000
            size:    4kB

        # User areas.
        FLASH_AREA_REBOOT_LOG:       # For logging debug messages during startup
            user_id: 0
            device:  0               # Internal Flash ROM
            offset:  0x00007000      # Note: 0x7f00-0x7fff contains the relocated vector table
            size:    4kB
        # FLASH_AREA_BOOTLOADER_ASSET: # Bootloader Assets, like Boot Graphic
        #   user_id: 1
        #   device:  1               # External SPI Flash
        #   offset:  0x00000000      # Start of External SPI Flash
        #   size:    256kB
        FLASH_AREA_NFFS:             # For user files
            user_id: 1
            device:  1               # External SPI Flash
            offset:  0x000b4000
            size:    3376kB
</code></pre>
<p><em>TODO: <code>0x7f00</code> to <code>0x7fff</code> is reserved for the relocated Vector Table. Active and Standby Firmware Images should be extended by 12 KB. Scratch Area and User File System should be moved down by 12 KB.</em></p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/spiflash">More about PineTime's SPI Flash</a></p>
<p>Here's the layout for <strong>PineTime's Flash ROM</strong>...</p>
<table><thead><tr><th align="left">     Flash ROM Area</th><th align="left">Address</th><th align="right">Size</th></tr></thead><tbody>
<tr><td align="left">     Bootloader (MCUBoot)</td><td align="left"><code>0x0000 0000</code></td><td align="right">28 KB</td></tr>
<tr><td align="left">     Reboot Log</td><td align="left"><code>0x0000 7000</code></td><td align="right">4 KB</td></tr>
<tr><td align="left">     <strong>Active Firmware Image</strong>      </td><td align="left"><strong><code>0x0000 8000</code></strong></td><td align="right">    <strong>464 KB</strong></td></tr>
<tr><td align="left">     Scratch Area</td><td align="left"><code>0x0007 C000</code></td><td align="right">4 KB</td></tr>
<tr><td align="left"><br></td><td align="left"></td><td align="right"></td></tr>
</tbody></table>
<p><em>TODO: <code>0x7f00</code> to <code>0x7fff</code> is reserved for the relocated Vector Table. Active Firmware Image should be extended by 12 KB. Scratch Area should be moved down by 12 KB</em></p>
<p>And the layout for <strong>PineTime's SPI Flash</strong>...</p>
<table><thead><tr><th align="left">     SPI Flash Area</th><th align="left">Address</th><th align="right">Size</th></tr></thead><tbody>
<tr><td align="left">     Bootloader Assets</td><td align="left"><code>0x0000 0000</code></td><td align="right">256 KB</td></tr>
<tr><td align="left">     <em>Standby Firmware Image</em>     </td><td align="left"><code>0x0004 0000</code></td><td align="right"><em>464 KB</em></td></tr>
<tr><td align="left">     User File System</td><td align="left"><code>0x000B 4000</code></td><td align="right">     3,376 KB</td></tr>
<tr><td align="left"><br></td><td align="left"></td><td align="right"></td></tr>
</tbody></table>
<p><em>TODO: Standby Firmware Image should be extended by 12 KB. User File System should be moved down by 12 KB</em></p>
<p>The <strong>User File System</strong> has been bumped up to a whopping <strong>3.2 MB</strong> (from 12 KB).</p>
<p>PineTime Watch Apps may store graphical assets and other app data in the User File System, once we install a Flash File System like littlefs.</p>
<p><a href="https://github.com/ARMmbed/littlefs/blob/master/README.md">More about littlefs</a></p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/spiflash">Supporting littlefs on PineTime</a></p>
<p><em>Bootloader Assets (256 KB) is a new flash area in SPI Flash. What's inside?</em></p>
<p>The Enhanced MCUBoot Bootloader now renders a Boot Graphic that's 112.5 KB in size. The Boot Graphic is stored in the <strong>Bootloader Assets</strong> flash area.</p>
<p>Half of the Bootloader Assets area is unused. We expect to use the free space to store fonts and other graphical assets that will be rendered by Enhanced MCUBoot.</p>
<p>The Bootloader Assets area doesn't use any Flash File System (like littlefs). We'll learn why in a while.</p>
<p><em>Why is Bootloader Assets commented out in the Flash Memory Map <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/hw/bsp/nrf52/bsp.yml"><code>hw/bsp/nrf52/bsp.yml</code></a>?</em></p>
<p>The Mynewt build fails when it encounters a custom flash area (like Bootloader Assets) in the Flash Memory Map. So it has been commented out. </p>
<p>But the SPI Flash space has been budgeted correctly, so that none of the other flash areas will overlap with Bootloader Assets.</p>
<p>Let's discover how PineTime's ST7789 Display Controller renders graphics...</p>
<h1 id="blasting-graphics-to-st7789-display-controller-on-pinetime" class="section-header"><a href="#blasting-graphics-to-st7789-display-controller-on-pinetime">2 Blasting Graphics to ST7789 Display Controller on PineTime</a></h1>
<p>Watch how Enhanced MCUBoot renders the Boot Graphic (hand-drawn PineTime logo) before starting the Application Firmware (&quot;<code>I AM PINETIME</code>&quot;)...</p>
<p><a href="https://twitter.com/MisterTechBlog/status/1261568945728876544?s=20">Watch video on Twitter</a></p>
<p><a href="https://qoto.org/@lupyuen/104177098953236703">Watch video on Mastodon</a></p>
<p>Enhanced MCUBoot needs to render the Boot Graphic the <strong>quickest and most reliable</strong> way possible because...</p>
<ol>
<li>
<p>PineTime Owners will see this every time PineTime powers on, so it must be quick</p>
</li>
<li>
<p>The rendering must not crash MCUBoot, even when SPI Flash is corrupted</p>
<p>(<em>Yes the Boot Graphic may look really awful, but PineTime must always boot!</em>)</p>
</li>
<li>
<p>And the rendering needs to be done within the 24 KB of code space allocated to Enhanced MCUBoot</p>
<p>(<em>Which means we'll have to make assumptions and hard code certain things</em>)</p>
</li>
</ol>
<p>Let's read the code in Enhanced MCUBoot and understand how it renders the Boot Graphic quickly and reliably: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a></p>
<h2 id="initialise-the-display" class="section-header"><a href="#initialise-the-display">2.1 Initialise The Display</a></h2>
<pre><code class="language-c">#define DISPLAY_CS   25  //  GPIO Pin 25 for LCD_CS (P0.25): Chip select
#define DISPLAY_DC   18  //  GPIO Pin 18 for LCD_RS (P0.18): Clock/data pin (CD)
#define DISPLAY_RST  26  //  GPIO Pin 26 for LCD_RESET (P0.26): Display reset
#define DISPLAY_HIGH 23  //  GPIO Pin 23 for LCD_BACKLIGHT_HIGH (23): High backlight (active low)

/// Initialise the ST7789 display controller
static int init_display(void) {
    //  Assume that SPI port 0 has been initialised by the SPI Flash Driver at startup.
    hal_gpio_init_out(DISPLAY_RST, 1);  //  Configure GPIO Pin for output
    hal_gpio_init_out(DISPLAY_CS, 1);
    hal_gpio_init_out(DISPLAY_DC, 0);
    hal_gpio_init_out(DISPLAY_HIGH, 0);  //  Switch on backlight

    hard_reset();  //  Reset the display controller by toggling the Reset GPIO Pin
    write_command(SWRESET, NULL, 0); delay_ms(200);  //  Write a command and delay for 200 milliseconds
    write_command(SLPOUT, NULL, 0); delay_ms(200);

    static const uint8_t FRMCTR1_PARA[] = { 0x01, 0x2C, 0x2D };
    write_command(FRMCTR1, FRMCTR1_PARA, sizeof(FRMCTR1_PARA));

    static const uint8_t FRMCTR2_PARA[] = { 0x01, 0x2C, 0x2D };
    write_command(FRMCTR2, FRMCTR2_PARA, sizeof(FRMCTR2_PARA));

    static const uint8_t FRMCTR3_PARA[] = { 0x01, 0x2C, 0x2D, 0x01, 0x2C, 0x2D };
    write_command(FRMCTR3, FRMCTR3_PARA, sizeof(FRMCTR3_PARA));

    static const uint8_t INVCTR_PARA[] = { 0x07 };
    write_command(INVCTR, INVCTR_PARA, sizeof(INVCTR_PARA));

    static const uint8_t PWCTR1_PARA[] = { 0xA2, 0x02, 0x84 };
    write_command(PWCTR1, PWCTR1_PARA, sizeof(PWCTR1_PARA));

    static const uint8_t PWCTR2_PARA[] = { 0xC5 };
    write_command(PWCTR2, PWCTR2_PARA, sizeof(PWCTR2_PARA));
    
    static const uint8_t PWCTR3_PARA[] = { 0x0A, 0x00 };
    write_command(PWCTR3, PWCTR3_PARA, sizeof(PWCTR3_PARA));
    
    static const uint8_t PWCTR4_PARA[] = { 0x8A, 0x2A };
    write_command(PWCTR4, PWCTR4_PARA, sizeof(PWCTR4_PARA));
    
    static const uint8_t PWCTR5_PARA[] = { 0x8A, 0xEE };
    write_command(PWCTR5, PWCTR5_PARA, sizeof(PWCTR5_PARA));
    
    static const uint8_t VMCTR1_PARA[] = { 0x0E };
    write_command(VMCTR1, VMCTR1_PARA, sizeof(VMCTR1_PARA));

    write_command(INVON, NULL, 0);

    static const uint8_t MADCTL1_PARA[] = { 0x00 };
    write_command(MADCTL, MADCTL1_PARA, sizeof(MADCTL1_PARA));

    static const uint8_t COLMOD_PARA[] = { 0x05 };
    write_command(COLMOD, COLMOD_PARA, sizeof(COLMOD_PARA));
    
    write_command(DISPON, NULL, 0); delay_ms(200);
    return 0;
}
</code></pre>
<p>Here's the code in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a> that initialises the <a href="https://wiki.pine64.org/images/5/54/ST7789V_v1.6.pdf"><strong>Sitronix ST7789 Display Controller</strong></a> for PineTime's 240 x 240 Colour LCD Screen. </p>
<p>At startup, the function above sends a bunch of commands and parameters to the ST7789 Display Controller via the SPI port. We send commands and data (parameters) to ST7789 in a peculiar way in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a>...</p>
<pre><code class="language-c">#define DISPLAY_SPI   0  //  ST7789 connected to SPI port 0
#define DISPLAY_DC   18  //  GPIO Pin 18 for LCD_RS (P0.18): Clock/data pin (CD)
#define DISPLAY_CS   25  //  GPIO Pin 25 for LCD_CS (P0.25): Chip select

/// Transmit ST7789 command
static int write_command(uint8_t command, const uint8_t *params, uint16_t len) {
    hal_gpio_write(DISPLAY_DC, 0);  //  Enter Command Mode
    transmit_spi(&amp;command, 1);
    if (params != NULL &amp;&amp; len &gt; 0) { write_data(params, len); }
    return 0;
}

/// Transmit ST7789 data
static int write_data(const uint8_t *data, uint16_t len) {
    hal_gpio_write(DISPLAY_DC, 1);  //  Enter Data Mode
    transmit_spi(data, len);
    return 0;
}

/// Write to the SPI port
static int transmit_spi(const uint8_t *data, uint16_t len) {    
    hal_gpio_write(DISPLAY_CS, 0);     //  Select the display controller    
    int rc = hal_spi_txrx(DISPLAY_SPI, //  Send to SPI port...
        (void *) data,                 //  Transmit Buffer
        NULL,                          //  Receive Buffer (NULL means don't receive)
        len);                          //  Length
    hal_gpio_write(DISPLAY_CS, 1);     //  De-select the display controller    
    return 0;
}
</code></pre>
<p>We toggle GPIO Pin 18 (<code>DISPLAY_DC</code>) to tell ST7789 whether we are sending a Command Byte or a sequence of Data Bytes. So in this example...</p>
<pre><code class="language-c">static const uint8_t FRMCTR1_PARA[] = { 0x01, 0x2C, 0x2D };
write_command(FRMCTR1, FRMCTR1_PARA, sizeof(FRMCTR1_PARA));
</code></pre>
<ol>
<li>
<p>We set GPIO Pin 18 to <strong>Low</strong> to transmit the <code>FRMCTR1</code> <strong>Command Byte</strong> <code>0xB1</code></p>
</li>
<li>
<p>Then set GPIO Pin 18 to <strong>High</strong> to transmit the <strong>Data Bytes</strong> <code>0x01</code>, <code>0x2C</code>, <code>0x2D</code></p>
</li>
</ol>
<p>Yes it's unusual, cumbersome and limits SPI performance. It was probably done to force-fit a 4-Line Serial Interface into the 3-Line SPI Interface.</p>
<p>Note: The above initialisation commands and parameters don't quite match up with the <a href="https://wiki.pine64.org/images/5/54/ST7789V_v1.6.pdf">ST7789 datasheet</a>. That's because the code was originally written for the <a href="https://www.displayfuture.com/Display/datasheet/controller/ST7735.pdf">ST7735 Display Controller</a>. This should be fixed, but it works on PineTime for now.</p>
<h2 id="draw-a-line" class="section-header"><a href="#draw-a-line">2.2 Draw A Line</a></h2>
<p>Let's look at the code to draw a line: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a></p>
<pre><code class="language-c">//  Set Address Window Columns (CASET)
write_command(CASET, NULL, 0);
static const uint8_t CASET2_PARA[] = { 
    0x00, 0x14,    //  From Column 20
    0x00, 0x27 };  //  To Column 39    
write_data(CASET2_PARA, sizeof(CASET2_PARA));

//  Set Address Window Rows (RASET)
write_command(RASET, NULL, 0);
static const uint8_t RASET2_PARA[] = { 
    0x00, 0x00,    //  From Row 0
    0x00, 0x00 };  //  To Row 0
write_data(RASET2_PARA, sizeof(RASET2_PARA));

//  Write Pixels (RAMWR)
write_command(RAMWR, NULL, 0);
static const uint8_t RAMWR2_PARA[] = {   //  40 bytes (20 pixels)
    0x87, 0xe0,    //  First Pixel Colour: 0x87e0 in RGB565 = Green-yellow
    0x87, 0xe0,    //  Second Pixel Colour
    ..., 
    0x87, 0xe0 };  //  20th Pixel Colour
write_data(RAMWR2_PARA, sizeof(RAMWR2_PARA));
</code></pre>
<p>To render a bitmap on the display, we send the <code>CASET</code> and <code>RASET</code> commands to define the window coordinates of the bitmap: Left (Column 20), Right (Column 39), Top (Row 0), Bottom (Row 0).</p>
<p>Then we send the <code>RAMWR</code> command followed by the pixel colours, row by row.  (Only 1 row of 20 pixels in the above example)</p>
<p>Each pixel colour consists of two bytes (like <code>0x87</code> <code>0xe0</code>), encoded in the RGB565 format.</p>
<p><a href="https://wiki.pine64.org/images/5/54/ST7789V_v1.6.pdf">See ST7789 datasheet</a></p>
<p><img src="https://lupyuen.github.io/images/mcuboot-rgb565.png" alt="RGB565" /></p>
<p>We call it RGB565 because it encodes 5 bits for Red, 6 bits for Green and 5 bits for Blue. Which adds up to 16 bits, or 2 bytes.</p>
<p><a href="https://stackoverflow.com/questions/25467682/rgb-565-why-6-bits-for-green-color">More about RGB565</a></p>
<p>For more details on PineTime's ST7789 Display Controller, check out this article...</p>
<p><a href="https://medium.com/@ly.lee/optimising-pinetimes-display-driver-with-rust-and-mynewt-3ba269ea2f5c?source=friends_link&amp;sk=4d2cbd2e6cd2343eed62d214814f7b81">Optimising PineTime’s Display Driver with Rust and Mynewt</a></p>
<p>Now that we can draw a line, let's extend the code to render the entire Boot Graphic, line by line.</p>
<h1 id="render-boot-graphic-from-spi-flash-on-pinetime" class="section-header"><a href="#render-boot-graphic-from-spi-flash-on-pinetime">3 Render Boot Graphic from SPI Flash on PineTime</a></h1>
<p>From <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a> we have seen the fastest, simplest functions to draw coloured lines with PineTime's ST7789 Display Controller.</p>
<p>Now let's call these functions to render the Boot Graphic in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a>...</p>
<pre><code class="language-c">#define BATCH_SIZE  256  //  Max number of SPI data bytes to be transmitted

//  Screen Buffer Size: 240 * 240 * 2 / 1024 = 112.5 KB
#define ROW_COUNT 240
#define COL_COUNT 240
#define BYTES_PER_PIXEL 2

//  Flash Device for Image
#define FLASH_DEVICE 1  //  0 for Internal Flash ROM, 1 for External SPI Flash

/// Buffer for reading flash and writing to display
static uint8_t flash_buffer[BATCH_SIZE];

/// Display the image in SPI Flash to ST7789 display controller. 
/// Derived from https://github.com/lupyuen/pinetime-rust-mynewt/blob/main/logs/spi-non-blocking.log
int pinetime_boot_display_image(void) {
    init_display();
    set_orientation(Landscape);

    //  Render each row of pixels.
    for (uint8_t row = 0; row &lt; ROW_COUNT; row++) {
        uint8_t top = row;     //  Top row
        uint8_t bottom = row;  //  Bottom row (same as top)
        uint8_t left = 0;      //  Left column
        //  Render a batch of columns in that row.
        for (;;) {
            if (left &gt;= COL_COUNT) { break; }

            //  How many columns we will render in a batch.
            uint16_t batch_columns = BATCH_SIZE / BYTES_PER_PIXEL;
            uint16_t right = left + batch_columns - 1;
            if (right &gt;= COL_COUNT) { right = COL_COUNT - 1; }

            //  How many bytes we will transmit.
            uint16_t len = (right - left + 1) * BYTES_PER_PIXEL;

            //  Read the bytes from flash memory.
            uint32_t offset = ((top * COL_COUNT) + left) * BYTES_PER_PIXEL;
            hal_flash_read(FLASH_DEVICE, offset, flash_buffer, len);

            //  Set the display window.
            set_window(left, top, right, bottom);

            //  Write Pixels (RAMWR)
            write_command(RAMWR, NULL, 0);
            write_data(flash_buffer, len);

            //  Move to the next batch of columns.
            left = right + 1;
        }
    }
    return 0;
}
</code></pre>
<p>Note that we call <code>hal_flash_read()</code> like this to read <code>len</code> bytes starting at flash address <code>offset</code> from the SPI Flash into <code>flash_buffer</code>...</p>
<pre><code class="language-c">hal_flash_read(FLASH_DEVICE, offset, flash_buffer, len);
</code></pre>
<p>Thus the function <code>pinetime_boot_display_image()</code> above keeps reading from SPI Flash (starting at address 0) and blasts everything to the Display Controller, row by row, 256 data bytes at a time.  It's blasting the entire Boot Graphic from SPI Flash to the Display Controller!</p>
<p>Here's the <code>set_window()</code> function in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a> that sets the display window coordinates...</p>
<pre><code class="language-c">/// Set the ST7789 display window to the coordinates (left, top), (right, bottom)
static int set_window(uint8_t left, uint8_t top, uint8_t right, uint8_t bottom) {
    //  Set Address Window Columns (CASET)
    write_command(CASET, NULL, 0);
    uint8_t col_para[4] = { 0x00, left, 0x00, right };
    write_data(col_para, 4);

    //  Set Address Window Rows (RASET)
    write_command(RASET, NULL, 0);
    uint8_t row_para[4] = { 0x00, top, 0x00, bottom };
    write_data(row_para, 4);
    return 0;
}
</code></pre>
<p><em>Remember that Enhanced MCUBoot needs to render the Boot Graphic the <strong>quickest and most reliable</strong> way possible?</em></p>
<p>We have accomplished that because...</p>
<ol>
<li>
<p>The rendering code is <strong>highly predictable (or deterministic)</strong></p>
<p>The code doesn't depend on the contents of SPI Flash... It blindly blasts the bitmap data from SPI Flash to the Display Controller. Even if the SPI Flash contains garbage! (Which displays garbage, of course).</p>
<p>Thus the rendering code will always terminate (without hanging). And it won't cause MCUBoot to crash or hang.</p>
</li>
<li>
<p>We don't compress the Boot Graphic. We don't use a Flash File System either.</p>
<p>Because compression or file system bugs (or badly-formatted data) may cause MCUBoot to crash or hang</p>
</li>
<li>
<p>There is <strong>no conversion or decompression</strong> of bitmap data</p>
<p>Hence it's very fast (Watch the video again)</p>
</li>
<li>
<p>We don't allow any <strong>background processing</strong> in MCUBoot</p>
<p>No multitasking, no Bluetooth Stack. Just single-threaded code for maximum predictability and reliability.</p>
</li>
</ol>
<p>When adding functions to MCUBoot, we need to assume that multitasking (Task Scheduler) is disabled. Here's an example from <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/display.c"><code>display.c</code></a>...</p>
<pre><code class="language-c">/// Sleep for the specified number of milliseconds
static void delay_ms(uint32_t ms) {
    #if MYNEWT_VAL(OS_SCHEDULING)  //  If Task Scheduler is enabled (i.e. not MCUBoot)...
        uint32_t delay_ticks = ms * OS_TICKS_PER_SEC / 1000;
        os_time_delay(delay_ticks);
    #else  //  If Task Scheduler is disabled (i.e. MCUBoot)...
        //  os_time_delay() doesn't work in MCUBoot because the Task Scheduler isn't started
        pinetime_boot_check_button();
    #endif  //  MYNEWT_VAL(OS_SCHEDULING)
}
</code></pre>
<p>Some system functions like <code>os_time_delay()</code> only work when the Task Scheduler is enabled. Since multitasking is disabled for MCUBoot, we'll have to use an alternative function like <code>pinetime_boot_check_button()</code>. </p>
<p>We'll cover <code>pinetime_boot_check_button()</code> in a while.</p>
<p>How shall we load a PNG graphic file to PineTime's SPI Flash as the Boot Graphic? We'll find out next.</p>
<h1 id="write-boot-graphic-to-spi-flash-on-pinetime" class="section-header"><a href="#write-boot-graphic-to-spi-flash-on-pinetime">4 Write Boot Graphic to SPI Flash on PineTime</a></h1>
<p>We have built a Rust desktop command-line tool that reads a PNG 24-bit RGB file (240 x 240 resolution), and converts it into ST7789's RGB565 format...</p>
<p><a href="https://github.com/lupyuen/pinetime-graphic"><code>github.com/lupyuen/pinetime-graphic</code></a></p>
<p>To run the tool and convert a PNG file named <code>pinetime-graphic.png</code>...</p>
<pre><code class="language-bash"># Assume Rust and cargo are already installed: https://rustup.rs
git clone https://github.com/lupyuen/pinetime-graphic
cd pinetime-graphic
cargo build
cargo run -v pinetime-graphic.png
</code></pre>
<p>The RGB565 values (115,200 bytes) will be dumped to the console like this...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,
<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,
...
<span class="number">0x05</span>, <span class="number">0xa3</span>, <span class="number">0x01</span>, <span class="number">0x20</span>, <span class="number">0x01</span>, <span class="number">0x20</span>, <span class="number">0x01</span>, <span class="number">0x20</span>, <span class="number">0x06</span>, <span class="number">0xe4</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>,
<span class="number">0x05</span>, <span class="number">0xe3</span>, <span class="number">0x02</span>, <span class="number">0xc1</span>, <span class="number">0x02</span>, <span class="number">0xa1</span>, <span class="number">0x03</span>, <span class="number">0x62</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>, <span class="number">0x07</span>, <span class="number">0xe5</span>, <span class="number">0x07</span>, <span class="number">0xc5</span>,
...</pre></div>
<p>Copy the converted RGB565 values and paste into <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/graphic.inc"><code>libs/pinetime_boot/src/graphic.inc</code></a>.</p>
<p>Then run this code on PineTime to load the converted RGB565 values into PineTime's SPI Flash: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/write.c"><code>libs/pinetime_boot/src/write.c</code></a></p>
<pre><code class="language-c">#define BATCH_SIZE  4096  //  Max number of data bytes to be written in a batch
#define FLASH_DEVICE 1    //  Flash Device: 0 for Flash ROM, 1 for SPI Flash

//  Converted from PNG file by https://github.com/lupyuen/pinetime-graphic
static const uint8_t image_data[] = {  //  Should be 115,200 bytes
#include &quot;graphic.inc&quot;
};

/// Write a converted graphic file to SPI Flash
int pinetime_boot_write_image(void) {
    uint32_t offset = 0;
    for (;;) {
        if (offset &gt;= sizeof(image_data)) { break; }
        //  How many bytes we will write.
        uint16_t len = BATCH_SIZE;
        if (offset + len &gt;= sizeof(image_data)) {
            len = sizeof(image_data) - offset;
        }        
        //  Erase the bytes.
        int rc = hal_flash_erase(FLASH_DEVICE, offset, len); 
        assert(rc == 0);

        //  Write the bytes.
        rc = hal_flash_write(FLASH_DEVICE, offset, (void *) &amp;image_data[offset], len); 
        assert(rc == 0);
        offset += len;
    }
    return 0;
}
</code></pre>
<p><code>hal_flash_erase()</code> and  <code>hal_flash_write()</code> are defined as follows...</p>
<ol>
<li>
<p><code>hal_flash_erase(id, offset, size)</code></p>
<p>Erase internal / external flash memory at the <code>offset</code> address, for <code>size</code> bytes. <a href="https://mynewt.apache.org/latest/os/modules/hal/hal_flash/hal_flash.html#c.hal_flash_erase">See <code>hal_flash_erase</code></a></p>
</li>
<li>
<p><code>hal_flash_write(id, offset, buf, size)</code></p>
<p>Write internal / external flash memory from the <code>buf</code> buffer to the <code>offset</code> address, for <code>size</code> bytes. <a href="https://mynewt.apache.org/latest/os/modules/hal/hal_flash/hal_flash.html#c.hal_flash_write">See <code>hal_flash_write</code></a></p>
</li>
</ol>
<h1 id="enable-custom-hooks-in-mcuboot" class="section-header"><a href="#enable-custom-hooks-in-mcuboot">5 Enable Custom Hooks in MCUBoot</a></h1>
<p>Earlier we resolved never to modify MCUBoot code because the MCUBoot Bootloader is a Critical and Secure part of PineTime. </p>
<p><em>How shall we add new functions to MCUBoot, like rendering the Boot Graphic?</em></p>
<p>Fortunately MCUBoot provides two spots for us to hook on additional functions...</p>
<ol>
<li>
<p><strong>Start of MCUBoot:</strong> MCUBoot calls our custom function via <strong><code>sysinit()</code></strong></p>
</li>
<li>
<p><strong>End of MCUBoot:</strong> MCUBoot calls our custom function via <strong><code>boot_custom_start()</code></strong></p>
</li>
</ol>
<p>Here's how the hooks are implemented in the Mynewt version of MCUBoot: <a href="https://github.com/JuulLabs-OSS/mcuboot/blob/master/boot/mynewt/src/main.c"><code>mcuboot/boot/mynewt/src/main.c</code></a></p>
<pre><code class="language-c">//  MCUBoot starts here.
int main(void) {

#if defined(MCUBOOT_HAVE_LOGGING)
    //  Initialise Mynewt drivers and libraries.
    sysinit();
#else
    //  By Default: Don't call sysinit() to initialise Mynewt drivers and libraries.
#endif

    //  MCUBoot does its work here. Swaps Active and Standby Firmware if necessary.
    boot_go(&amp;rsp);
    flash_device_base(rsp.br_flash_dev_id, &amp;flash_base);
    //  MCUBoot has completed its work.

#if MYNEWT_VAL(BOOT_CUSTOM_START)
    //  Call custom boot function to start the Application Firmware
    boot_custom_start(flash_base, &amp;rsp);  
#else
    //  By Default: Start the Application Firmware directly
    hal_system_start((void *)(flash_base + rsp.br_image_off + rsp.br_hdr-&gt;ih_hdr_size));
#endif

    return 0;
}
</code></pre>
<p>Let's enable both MCUBoot hooks in our Enhanced MCUBoot for PineTime: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/tree/master/targets/nrf52_boot"><code>targets/nrf52_boot</code></a></p>
<h2 id="enable-sysinit-hook" class="section-header"><a href="#enable-sysinit-hook">5.1 Enable <code>sysinit()</code> Hook</a></h2>
<p>To enable the <code>sysinit()</code> hook when MCUBoot starts, we define <code>MCUBOOT_HAVE_LOGGING</code> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/targets/nrf52_boot/pkg.yml"><code>targets/nrf52_boot/pkg.yml</code></a>...</p>
<pre><code class="language-yaml"># Package Dependencies: MCUBoot is dependent on these drivers and libraries.
pkg.deps:
    - &quot;libs/semihosting_console&quot;  #  Semihosting Console
    - &quot;libs/pinetime_boot&quot;        #  Render boot graphic and check for rollback

#  C compiler flags
pkg.cflags:
    - -DMCUBOOT_HAVE_LOGGING=1  #  So that sysinit() will be run, needed for displaying boot graphic
</code></pre>
<p>We have added two libraries to MCUBoot...</p>
<ol>
<li>
<p><strong><a href="https://github.com/lupyuen/pinetime-rust-mynewt/tree/master/libs/semihosting_console"><code>semihosting_console</code> Library</a>:</strong> Display debugging messages from MCUBoot via the Arm Semihosting Console (in OpenOCD). </p>
<p>The debugging messages are automatically disabled if PineTime's SWD Port is not connected.</p>
</li>
<li>
<p><strong><a href="https://github.com/lupyuen/pinetime-rust-mynewt/tree/master/libs/pinetime_boot"><code>pinetime_boot</code> Library</a>:</strong> Implements the Enhanced MCUBoot functions (like rendering the Boot Graphic).</p>
<p>More about <code>pinetime_boot</code> in a while.</p>
</li>
</ol>
<h2 id="enable-boot_custom_start-hook" class="section-header"><a href="#enable-boot_custom_start-hook">5.2 Enable <code>boot_custom_start()</code> Hook</a></h2>
<p>To enable the <code>boot_custom_start()</code> hook when MCUBoot completes its processing, we set <code>BOOT_CUSTOM_START</code> to <code>1</code> in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/targets/nrf52_boot/syscfg.yml"><code>targets/nrf52_boot/syscfg.yml</code></a>...</p>
<pre><code class="language-yaml"># MCUBoot Bootloader Settings
syscfg.vals:
    BOOT_CUSTOM_START:        1  # Use custom boot function boot_custom_start()
    OS_MAIN_STACK_SIZE:    1024  # Small stack size: 4 KB
    MSYS_1_BLOCK_COUNT:      64  # Allocate MSYS buffers for Semihosting Console

    # Hardware Settings
    SPIFLASH:                 1  # Enable SPI Flash
    SPI_0_MASTER:             1  # Enable SPI port 0 for ST7789 display and SPI Flash
</code></pre>
<p>We have enabled the SPI port (<code>SPI_0_MASTER</code>) as well as the SPI Flash driver (<code>SPIFLASH</code>). </p>
<p><code>MSYS_1_BLOCK_COUNT</code> needs to be set so that debugging messages from MCUBoot will appear on the Arm Semihosting Console (in OpenOCD).  The Semihosting Console Library uses MSYS buffers for buffering debugging messages in RAM.</p>
<p>Let's find out how the PineTime Boot Library <code>pinetime_boot</code> implements the MCUBoot custom hooks.</p>
<h1 id="extend-mcuboot-with-pinetime-boot-library" class="section-header"><a href="#extend-mcuboot-with-pinetime-boot-library">6 Extend MCUBoot with PineTime Boot Library</a></h1>
<p>Previously we have enabled both hooks in PineTime's Enhanced MCUBoot...</p>
<ol>
<li>
<p><code>sysinit()</code>: Called by MCUBoot when it starts</p>
</li>
<li>
<p><code>boot_custom_start()</code>: Called by MCUBoot when it has completed its work</p>
</li>
</ol>
<p>Let's learn how both hooks are handled by the <strong>PineTime Boot Library</strong>: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/tree/master/libs/pinetime_boot"><code>libs/pinetime_boot</code></a></p>
<h2 id="handle-mcuboot-sysinit-hook" class="section-header"><a href="#handle-mcuboot-sysinit-hook">6.1 Handle MCUBoot <code>sysinit()</code> Hook</a></h2>
<p><code>sysinit()</code> is a special function that's automatically generated when we build the Bootloader and Application Firmware in Mynewt. </p>
<p>Here's the auto-generated <code>sysinit()</code> function for our Enhanced MCUBoot Bootloader: <code>bin/targets/nrf52_boot/generated/src/nrf52_boot-sysinit-app.c</code></p>
<pre><code class="language-c">void sysinit_app(void) {
    //  Stage 0.0: os_pkg_init (kernel/os)
    os_pkg_init();

    //  Stage 2.0: flash_map_init (sys/flash_map)
    flash_map_init();

    //  Stage 20.0: console_pkg_init (libs/semihosting_console)
    console_pkg_init();

    //  Stage 100.0: mfg_init (sys/mfg)
    mfg_init();
    //  Stage 100.1: modlog_init (sys/log/modlog)
    modlog_init();

    //  Stage 900.0: pinetime_boot_init (libs/pinetime_boot)
    pinetime_boot_init();
}
</code></pre>
<p><code>sysinit()</code> is aliased to <code>sysinit_app()</code>. This function is called when our Bootloader starts. It initialises the Mynewt operating system, drivers and libraries.</p>
<p>Note that <code>sysinit()</code> calls our custom function <code>pinetime_boot_init()</code> when the Bootloader starts.</p>
<p><em>How did we add <code>pinetime_boot_init()</code> to <code>sysinit()</code>?</em></p>
<p>By configuring the PineTime Boot Library like this: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/pkg.yml"><code>libs/pinetime_boot/pkg.yml</code></a></p>
<pre><code class="language-yaml">pkg.init:
    # pinetime_boot should be initialised last, when SPI and Semihosting Console are up
    pinetime_boot_init: 900  # Call pinetime_boot_init() to initialise and render boot graphic
</code></pre>
<p>We configured <code>pinetime_boot_init()</code> to run at Stage 900, so that it will run after all drivers and libraries have been started (especially the SPI Flash Driver).</p>
<p><em>What's inside our <code>pinetime_boot_init()</code> function?</em></p>
<p><code>pinetime_boot_init()</code> runs when MCUBoot starts. Here's what it does: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/pinetime_boot.c"><code>libs/pinetime_boot/src/pinetime_boot.c</code></a></p>
<pre><code class="language-c">/// Init the display and render the boot graphic. Called by sysinit() during startup, defined in pkg.yml.
void pinetime_boot_init(void) {
    ...
    //  Display the Boot Graphic.
    pinetime_boot_display_image();
}
</code></pre>
<p><code>pinetime_boot_init()</code> calls <code>pinetime_boot_display_image()</code> to display the Boot Graphic.</p>
<p>Earlier we have seen how <code>pinetime_boot_display_image()</code> blasts the Boot Graphic from SPI Flash to PineTime's Display Controller.</p>
<p>Thus our Boot Graphic is rendered when Enhanced MCUBoot starts!</p>
<h2 id="handle-mcuboot-boot_custom_start-hook" class="section-header"><a href="#handle-mcuboot-boot_custom_start-hook">6.2 Handle MCUBoot <code>boot_custom_start()</code> Hook</a></h2>
<p><code>boot_custom_start()</code> is called by MCUBoot when it has completed its work (like swapping the Active and Standby Firmware Images).</p>
<p>We define <code>boot_custom_start()</code> in our PineTime Boot Library like this: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/pinetime_boot.c"><code>libs/pinetime_boot/src/pinetime_boot.c</code></a></p>
<pre><code class="language-c">/// Called by MCUBoot when it has completed its work.
void boot_custom_start(
    uintptr_t flash_base,
    struct boot_rsp *rsp
) {
    ...
    //  Start the Active Firmware Image. Copied from MCUBoot main().
    hal_system_start((void *)(
        flash_base + 
        rsp-&gt;br_image_off +
        rsp-&gt;br_hdr-&gt;ih_hdr_size
    ));
}
</code></pre>
<p><code>boot_custom_start()</code> calls <code>hal_system_start()</code> to jump to the Active Firmware Image, since our Enhanced MCUBoot Bootloader has completed its work.</p>
<p>In the next section we'll see that <code>boot_custom_start()</code> performs another function on PineTime: Rolling back the firmware when the watch button is pressed.</p>
<h1 id="manual-firmware-rollback-on-pinetime" class="section-header"><a href="#manual-firmware-rollback-on-pinetime">7 Manual Firmware Rollback on PineTime</a></h1>
<p>To prevent PineTime from getting bricked during firmware update, MCUBoot will automatically roll back the new firmware (Active Firmware) to the older firmware (Standby Firmware) if the new firmware fails to start properly (or fails to set the Firmware OK flag).</p>
<p><em>What if the PineTime Owner decides that the new firmware is not working properly, and wishes to roll back the firmware manually?</em></p>
<p>We shall check for Manual Firmware Rollback like this: If the Owner presses and holds the watch button for 5 seconds while the watch is booting up, the MCUBoot Bootloader shall roll back the firmware.</p>
<p>The manual rollback logic will be implemented in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/pinetime_boot.c"><code>libs/pinetime_boot/src/pinetime_boot.c</code></a>...</p>
<pre><code class="language-c">#define PUSH_BUTTON_IN  13  //  P0.13: PUSH BUTTON_IN
#define PUSH_BUTTON_OUT 15  //  P0.15/TRACEDATA2: PUSH BUTTON_OUT

/// Init the display and render the boot graphic. Called by sysinit() during startup, defined in pkg.yml.
void pinetime_boot_init(void) {
    //  Init the push button. The button on the side of the PineTime is disabled by default. To enable it, drive the button out pin (P0.15) high.
    //  While enabled, the button in pin (P0.13) will be high when the button is pressed, and low when it is not pressed. 
    hal_gpio_init_in(PUSH_BUTTON_IN, HAL_GPIO_PULL_DOWN);  //  TODO: Doesn't seem to detect button press
    hal_gpio_init_out(PUSH_BUTTON_OUT, 1);
    hal_gpio_write(PUSH_BUTTON_OUT, 1);  //  Enable the button

    //  Display the image.
    pinetime_boot_display_image();
}

/// Called by MCUBoot when it has completed its work.
void boot_custom_start(
    uintptr_t flash_base,
    struct boot_rsp *rsp
) {
    //  Wait 5 seconds for button press.
    for (int i = 0; i &lt; 15; i++) {
        pinetime_boot_check_button();
    }

    //  TODO: If button is pressed and held for 5 seconds, rollback the firmware.

    //  Start the Active Firmware Image. Copied from MCUBoot main().
    hal_system_start((void *)(
        flash_base + 
        rsp-&gt;br_image_off +
        rsp-&gt;br_hdr-&gt;ih_hdr_size
    ));
}

/// Check whether the watch button is pressed
void pinetime_boot_check_button(void) {
    for (int i = 0; i &lt; 1000000; i++) {
        //  TODO: Remember whether the button is pressed and held
        hal_gpio_read(PUSH_BUTTON_IN);  //  TODO: Doesn't seem to detect button press
    }
}
</code></pre>
<p>In <code>pinetime_boot_init()</code>, which is called when the MCUBoot Bootloader starts, we initialise the GPIO Pins for the watch button. Then we let MCUBoot do its work.</p>
<p>When MCUBoot has finished working, it calls <code>boot_custom_start()</code>. Here we wait 5 seconds and check whether the button has been pressed and held for 5 seconds.</p>
<p>If so, we roll back the firmware.</p>
<h1 id="test-enhanced-mcuboot-bootloader-on-pinetime" class="section-header"><a href="#test-enhanced-mcuboot-bootloader-on-pinetime">8 Test Enhanced MCUBoot Bootloader on PineTime</a></h1>
<p>[ UPDATE: <a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">Check out the testing of Wireless Firmware Updates on PineTime</a> ]</p>
<p>To test Enhanced MCUBoot Bootloader on PineTime, download the binaries here...</p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/tag/v4.1.1"><code>pinetime-rust-mynewt/releases/tag/v4.1.1</code></a></p>
<ol>
<li>
<p><strong><code>mynewt.*</code>: Enhanced MCUBoot Bootloader</strong> (based on MCUBoot 1.5.0) that supports Boot Graphic and SPI Flash</p>
</li>
<li>
<p><strong><code>my_sensor_app.*</code>: Application Firmware</strong> (based on Mynewt+Rust) that supports firmware update over Bluetooth</p>
</li>
<li>
<p><strong><code>boot-graphic.bin</code>: Boot Graphic</strong> in RGB565 format (Hand-drawn PineTime Logo)</p>
</li>
<li>
<p><strong><code>pinetime-rust-mynewt.7z</code>: Mynewt Build Files</strong> generated on macOS</p>
</li>
</ol>
<p>To install Enhanced MCUBoot Bootloader...</p>
<ol>
<li>
<p>Flash the <strong>Enhanced MCUBoot Bootloader</strong> <code>mynewt.bin</code> to address <code>0x0</code> in Internal Flash ROM</p>
</li>
<li>
<p><strong>Application Firmware Image</strong> (<code>my_sensor_app.img</code>, or your firmware image containing MCUBoot Image Header) should be flashed to address <code>0x8000</code> in Internal Flash ROM</p>
</li>
<li>
<p>During <strong>Firmware Update,</strong> the new firmware image (<code>my_sensor_app.img</code>, or your firmware image containing MCUBoot Image Header) should be flashed to address <code>0x40000</code> in External SPI Flash</p>
</li>
<li>
<p><strong>Optional: Boot Graphic</strong> <code>boot-graphic.bin</code> should be flashed to address <code>0x0</code> in External SPI Flash.</p>
<p>Boot Graphic is in RGB565 format, 240 x 240 pixels, 2 bytes per pixel.</p>
<p>Use this tool to convert a 240 x 240 PNG file to RGB565: <a href="https://github.com/lupyuen/pinetime-graphic"><code>github.com/lupyuen/pinetime-graphic</code></a></p>
</li>
</ol>
<p>We should see this on the PineTime screen...</p>
<ul>
<li>
<p><a href="https://twitter.com/MisterTechBlog/status/1261568945728876544?s=20">Watch video on Twitter</a></p>
</li>
<li>
<p><a href="https://qoto.org/@lupyuen/104177098953236703">Watch video on Mastodon</a></p>
</li>
</ul>
<ol>
<li>
<p>When PineTime is powered on, we see <strong>white noise</strong> (snow) briefly as MCUBoot starts</p>
</li>
<li>
<p>MCUBoot renders the <strong>hand-drawn PineTime logo</strong> in under 1 second</p>
</li>
<li>
<p>MCUBoot waits 5 seconds for <strong>Manual Firmware Rollback</strong> (simulated for now)</p>
</li>
<li>
<p>MCUBoot starts the <strong>Application Firmware</strong></p>
</li>
<li>
<p>Mynewt Application Firmware <strong>resets the Backlight and Display Controller,</strong> causing the screen to blank (needs to be fixed)</p>
</li>
<li>
<p>Mynewt Application Firmware <strong>switches on the Backlight.</strong> The hand-drawn PineTime logo previously rendered is now visible.</p>
</li>
<li>
<p>Mynewt Application Firmware <strong>erases the screen very slowly</strong> via the Rust driver for ST7789 Display Controller</p>
</li>
<li>
<p>Mynewt Application Firmware <strong>renders some shapes</strong> and the message &quot;<code>I AM PINETIME</code>&quot;</p>
</li>
</ol>
<p>Here is the log that appears on Semihosting Console in OpenOCD...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Starting</span> <span class="ident">Bootloader</span>...
<span class="ident">Displaying</span> <span class="ident">image</span>...
<span class="ident">Image</span> <span class="ident">displayed</span>
<span class="ident">Button</span>: <span class="number">0</span>
[<span class="ident">INF</span>] <span class="ident">Primary</span> <span class="ident">image</span>: <span class="ident">magic</span><span class="op">=</span><span class="ident">unset</span>, <span class="ident">swap_type</span><span class="op">=</span><span class="number">0x1</span>, <span class="ident">copy_done</span><span class="op">=</span><span class="number">0x3</span>, <span class="ident">image_ok</span><span class="op">=</span><span class="number">0x3</span>
[<span class="ident">INF</span>] <span class="ident">Scratch</span>: <span class="ident">magic</span><span class="op">=</span><span class="ident">unset</span>, <span class="ident">swap_type</span><span class="op">=</span><span class="number">0x1</span>, <span class="ident">copy_done</span><span class="op">=</span><span class="number">0x3</span>, <span class="ident">image_ok</span><span class="op">=</span><span class="number">0x3</span>
[<span class="ident">INF</span>] <span class="ident">Boot</span> <span class="ident">source</span>: <span class="ident">primary</span> <span class="ident">slot</span>
[<span class="ident">INF</span>] <span class="ident">Swap</span> <span class="kw">type</span>: <span class="ident">none</span>
<span class="ident">Button</span>: <span class="number">0</span>
<span class="ident">Button</span>: <span class="number">0</span>
<span class="ident">Bootloader</span> <span class="ident">done</span>
<span class="ident">TMP</span> <span class="ident">create</span> <span class="ident">temp_stub_0</span>
<span class="ident">NET</span> <span class="ident">hwid</span> <span class="number">4a</span> <span class="ident">f8</span> <span class="ident">cf</span> <span class="number">95</span> <span class="number">6a</span> <span class="ident">be</span> <span class="ident">c1</span> <span class="ident">f6</span> <span class="number">89</span> <span class="ident">ba</span> <span class="number">12</span> <span class="number">1a</span> 
<span class="ident">NET</span> <span class="ident">standalone</span> <span class="ident">node</span> 
<span class="ident">Testing</span> <span class="ident">flash</span>...
<span class="ident">Read</span> <span class="ident">Internal</span> <span class="ident">Flash</span> <span class="ident">ROM</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x20</span> <span class="number">0xd9</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0008</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x37</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Read</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
  <span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0008</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
  <span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Flash</span> <span class="ident">OK</span>
<span class="ident">Rust</span> <span class="ident">test</span> <span class="ident">display</span></pre></div>
<p>The Enhanced MCUBoot Bootloader for PineTime is now <strong>22 KB</strong> in size. Here are the sizes of each MCUBoot component...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="op">+</span> <span class="ident">newt</span> <span class="ident">size</span> <span class="op">-</span><span class="ident">v</span> <span class="ident">nrf52_boot</span>
<span class="ident">Size</span> <span class="ident">of</span> <span class="ident">Application</span> <span class="ident">Image</span>: <span class="ident">app</span>
<span class="ident">Mem</span> <span class="ident">FLASH</span>: <span class="number">0x0</span><span class="op">-</span><span class="number">0x6000</span>
<span class="ident">Mem</span> <span class="ident">RAM</span>: <span class="number">0x20000000</span><span class="op">-</span><span class="number">0x20010000</span>
  <span class="ident">FLASH</span>     <span class="ident">RAM</span> 
     <span class="number">90</span>     <span class="number">229</span> <span class="kw-2">*</span><span class="ident">fill</span><span class="op">*</span>
   <span class="number">6863</span>    <span class="number">5996</span> <span class="ident">boot_bootutil</span>.<span class="ident">a</span>
    <span class="number">124</span>       <span class="number">0</span> <span class="ident">boot_mynewt</span>.<span class="ident">a</span>
     <span class="number">18</span>       <span class="number">0</span> <span class="ident">boot_mynewt_flash_map_backend</span>.<span class="ident">a</span>
   <span class="number">1180</span>       <span class="number">0</span> <span class="ident">crypto_mbedtls</span>.<span class="ident">a</span>
    <span class="number">392</span>     <span class="number">444</span> <span class="ident">hw_bsp_nrf52</span>.<span class="ident">a</span>
     <span class="number">52</span>       <span class="number">0</span> <span class="ident">hw_cmsis</span><span class="op">-</span><span class="ident">core</span>.<span class="ident">a</span>
   <span class="number">1302</span>      <span class="number">80</span> <span class="ident">hw_drivers_flash_spiflash</span>.<span class="ident">a</span>
    <span class="number">662</span>       <span class="number">1</span> <span class="ident">hw_hal</span>.<span class="ident">a</span>
   <span class="number">4190</span>      <span class="number">72</span> <span class="ident">hw_mcu_nordic_nrf52xxx</span>.<span class="ident">a</span>
   <span class="number">2022</span>   <span class="number">18776</span> <span class="ident">kernel_os</span>.<span class="ident">a</span>
   <span class="number">1784</span>      <span class="number">12</span> <span class="ident">libc_baselibc</span>.<span class="ident">a</span>
   <span class="number">1312</span>     <span class="number">256</span> <span class="ident">libs_pinetime_boot</span>.<span class="ident">a</span>
    <span class="number">539</span>      <span class="number">40</span> <span class="ident">libs_semihosting_console</span>.<span class="ident">a</span>
    <span class="number">548</span>     <span class="number">128</span> <span class="ident">sys_flash_map</span>.<span class="ident">a</span>
      <span class="number">2</span>       <span class="number">0</span> <span class="ident">sys_log_modlog</span>.<span class="ident">a</span>
    <span class="number">666</span>      <span class="number">29</span> <span class="ident">sys_mfg</span>.<span class="ident">a</span>
     <span class="number">30</span>       <span class="number">5</span> <span class="ident">sys_sysinit</span>.<span class="ident">a</span>
     <span class="number">48</span>       <span class="number">0</span> <span class="ident">util_mem</span>.<span class="ident">a</span>
    <span class="number">100</span>       <span class="number">0</span> <span class="ident">nrf52_boot</span><span class="op">-</span><span class="ident">sysinit</span><span class="op">-</span><span class="ident">app</span>.<span class="ident">a</span>
    <span class="number">768</span>       <span class="number">0</span> <span class="ident">libgcc</span>.<span class="ident">a</span>
<span class="ident">Loading</span> <span class="ident">compiler</span> <span class="op">/</span><span class="ident">Users</span><span class="op">/</span><span class="ident">Luppy</span><span class="op">/</span><span class="ident">PineTime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">compiler</span><span class="op">/</span><span class="ident">arm</span><span class="op">-</span><span class="ident">none</span><span class="op">-</span><span class="ident">eabi</span><span class="op">-</span><span class="ident">m4</span>, <span class="ident">buildProfile</span> <span class="ident">debug</span>

<span class="ident">objsize</span>
   <span class="ident">text</span>    <span class="ident">data</span>     <span class="ident">bss</span>     <span class="ident">dec</span>     <span class="ident">hex</span> <span class="ident">filename</span>
  <span class="number">22620</span>     <span class="number">132</span>   <span class="number">25504</span>   <span class="number">48256</span>    <span class="ident">bc80</span> <span class="op">/</span><span class="ident">Users</span><span class="op">/</span><span class="ident">Luppy</span><span class="op">/</span><span class="ident">PineTime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_boot</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">boot</span><span class="op">/</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">mynewt</span>.<span class="ident">elf</span></pre></div>
<h1 id="more-enhancements-for-pinetime-bootloader" class="section-header"><a href="#more-enhancements-for-pinetime-bootloader">9 More Enhancements for PineTime Bootloader</a></h1>
<p>[ UPDATE: <a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">Check out the testing of Wireless Firmware Updates on PineTime</a> ]</p>
<p>While writing this article, PineTime Firmware Developers have provided plenty of valuable feedback. Here are the proposed enhancements based on their feedback...</p>
<ol>
<li>
<p><strong>Boot Graphic Compression:</strong> Reserving 112 KB of SPI Flash Memory for the Boot Graphic seems rather excessive. Surely we can compress the RGB555 bitmap and save space?</p>
<p>Yes! We shall be compressing the Boot Graphic as an enhancement.</p>
<p>The current version of Enhanced MCUBoot is focused on <strong>stability for easier testing,</strong> so no compression was used. </p>
<p>Meanwhile we'll look for a suitable bitmap compression module that performs efficiently on PineTime and doesn't crash when working on corrupted data.</p>
</li>
<li>
<p><strong>Space for Bootloader Assets:</strong> 256 KB of SPI Flash Memory (4 MB) is reserved for Bootloader Assets (which includes the Boot Graphics)... Too much maybe?</p>
<p>Half of the space is now used by the uncompressed Boot Graphic. When we implement Boot Graphic Compression, we shall shrink the Bootloader Assets space.</p>
<p><em>What about the other half of the Bootloader Assets space?</em></p>
<p>The space may be used for storing graphical assets like icons, fonts, and animations.  How we'll actually use the space will depend on this exciting new open source collaboration...</p>
</li>
<li>
<p><strong>Collaboration with <a href="https://twitter.com/minodesign">minodesign</a>:</strong> With PineTime we start with a blank slate for creating a FOSSy Smart Watch. Since PineTime Owners will have full freedom to tweak their watches, we'll encounter interesting ownership questions like...</p>
<p><strong>When you're a PineTime Owner, how would you show others that this watch is really yours?</strong></p>
<p><em>Do we show your handwriting when PineTime starts up? Or a photo?</em></p>
<p><em>(It's a shame that all iPhones and Apple Watches look the same!)</em></p>
<p>We're happy to collaborate with <a href="https://twitter.com/minodesign">minodesign</a> to tackle these difficult questions. </p>
<p>We'll start by creating a <strong>Bootloader User Experience</strong> that showcases the Free and Open Source nature of PineTime. Stay tuned!</p>
</li>
<li>
<p><strong>Onboarding of PineTime Firmware:</strong> Now that we have a stable Bootloader for PineTime that supports <strong>Wireless Firmware Updates</strong>... Let's bring onboard all PineTime Firmware Developers!</p>
<p>We are now testing various PineTime operating systems for Wireless Firmware Updates: <a href="https://github.com/JF002/Pinetime"><strong>FreeRTOS</strong></a>, <a href="https://github.com/lupyuen/pinetime-rust-mynewt"><strong>Mynewt + Rust</strong></a>, possibly others.</p>
<p><strong>PineTime will be the very first gadget that lets you switch to a different operating system wirelessly... And switch back!</strong></p>
<p>Some PineTime operating systems require more integration coding than others. I'll be helping to integrate <a href="https://github.com/daniel-thompson/wasp-os"><strong>wasp-os (MicroPython)</strong></a> with the NimBLE Bluetooth Stack.</p>
</li>
</ol>
<p>If you're keen to solve these challenges the open source way, come join us!</p>
<p>Chat with us on Matrix / Discord / Telegram / IRC: <a href="https://wiki.pine64.org/index.php/PineTime#Community">PineTime Community</a></p>
<h1 id="bootloader-watchdog" class="section-header"><a href="#bootloader-watchdog">10 Bootloader Watchdog</a></h1>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/tag/v5.0.4">PineTime MCUBoot Bootloader v5.0.4 (17 Sep 2020)</a> and later releases will activate the nRF52 Watchdog. The Watchdog needs to be <strong>tickled every 7 seconds or PineTime will forcibly reboot.</strong></p>
<p>This is needed in case the firmware is stuck in a loop or having peripheral issues (like SPI Bus Corruption).</p>
<p>The Watchdog is activated in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/pinetime_boot.c#L86-L103"><code>libs/pinetime_boot/src/pinetime_boot.c</code></a>...</p>
<pre><code class="language-c">void setup_watchdog() {
  NRF_WDT-&gt;CONFIG &amp;= ~(WDT_CONFIG_SLEEP_Msk &lt;&lt; WDT_CONFIG_SLEEP_Pos);
  NRF_WDT-&gt;CONFIG |= (WDT_CONFIG_HALT_Run &lt;&lt; WDT_CONFIG_SLEEP_Pos);

  NRF_WDT-&gt;CONFIG &amp;= ~(WDT_CONFIG_HALT_Msk &lt;&lt; WDT_CONFIG_HALT_Pos);
  NRF_WDT-&gt;CONFIG |= (WDT_CONFIG_HALT_Pause &lt;&lt; WDT_CONFIG_HALT_Pos);

  /* timeout (s) = (CRV + 1) / 32768 */
  const int timeoutSeconds = 7; // 7 seconds
  uint32_t crv = (((timeoutSeconds*1000u) &lt;&lt; 15u) / 1000) - 1;
  NRF_WDT-&gt;CRV = crv;

  /* Enable reload requests */
  NRF_WDT-&gt;RREN = (WDT_RREN_RR0_Enabled &lt;&lt; WDT_RREN_RR0_Pos);
  
  /* Start */
  NRF_WDT-&gt;TASKS_START = 1;
}
</code></pre>
<p>For Application Firmware created with Mynewt, we may set <code>SANITY_INTERVAL</code> to <code>5000</code> to tickle the Watchdog automatically every 5 seconds: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/lvgl/apps/my_sensor_app/syscfg.yml#L119-L127"><code>apps/my_sensor_app/syscfg.yml</code></a></p>
<pre><code class="language-yaml">syscfg.vals:
    # The default PineTime bootloader will setup a 7 second watchdog
    SANITY_INTERVAL: 5000  #  Tickle the watchdog every 5 seconds, that the watchdog won't trigger a reboot
</code></pre>
<p>To simulate the Watchdog with Mynewt Application Firmware, set <code>WATCHDOG_INTERVAL</code> to <code>7000</code>: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/lvgl/apps/my_sensor_app/syscfg.yml#L119-L127"><code>apps/my_sensor_app/syscfg.yml</code></a></p>
<pre><code class="language-yaml">syscfg.vals:
    WATCHDOG_INTERVAL: 7000  #  If watchdog is not set, set it to 7 seconds
</code></pre>
<p>Note that once the Watchdog is activated (by the Bootloader or Application Firmware), <strong>the Watchdog may not be disabled or changed to a different timeout value.</strong></p>
<p>In the PineTime MCUBoot Bootloader we also override the default Mynewt <strong>Non-Maskable Interrupt Handler</strong>, which is triggered by an Assertion Failure (e.g. due to SPI Bus Corruption). </p>
<p>In our custom Non-Maskable Interrupt Handler (and <strong>Hard Fault Handler</strong>), the Bootloader blinks 4 times quickly and reboots: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/libs/pinetime_boot/src/pinetime_boot.c#L170-L183"><code>libs/pinetime_boot/src/pinetime_boot.c</code></a></p>
<pre><code class="language-c">/// Blink 4 times and reboot
static void blink_and_restart() {
    //  Blink the screen quickly 4 times
    blink_backlight(4, 4);
    //  Then reboot, which fixes the SPI Bus
    NVIC_SystemReset();
}

/// In case of Non-Maskable Interrupt (e.g. assertion failure), blink 4 times and reboot.
/// Assertion failure may be due to SPI Bus corruption, which causes SPI Flash access to fail in spiflash_identify() in repos/apache-mynewt-core/hw/drivers/flash/spiflash/src/spiflash.c
void NMI_Handler() {
    //  Blink and restart
    blink_and_restart();
}

/// In case of Hard Fault, blink 4 times and reboot
void HardFault_Handler() {
    //  Blink and restart
    blink_and_restart();
}
</code></pre>
<p>The default Mynewt Non-Maskable Interrupt Handler and Hard Fault Handler will loop infinitely, and would have hung our Bootloader.</p>
<h1 id="build-and-flash-mcuboot-bootloader" class="section-header"><a href="#build-and-flash-mcuboot-bootloader">11 Build and Flash MCUBoot Bootloader</a></h1>
<p>Follow these steps to build the MCUBoot Bootloader on Linux (including Raspberry Pi) and macOS...</p>
<h2 id="install-build-tools" class="section-header"><a href="#install-build-tools">11.1 Install Build Tools</a></h2>
<ol>
<li>
<p>For macOS: Install OpenOCD from <a href="https://xpack.github.io/openocd/">The xPack OpenOCD</a>. Older versions of OpenOCD are known to have problems flashing with ST-Link.</p>
<p>Download and unzip OpenOCD for macOS: <a href="https://github.com/gnu-mcu-eclipse/openocd/releases/download/v0.10.0-11-20190118/gnu-mcu-eclipse-openocd-0.10.0-11-20190118-1134-macos.tgz"><code>gnu-mcu-eclipse-openocd-0.10.0-11-20190118-1134-macos.tgz</code></a></p>
</li>
<li>
<p>Install GCC and Python build tools for Linux (or the macOS equivalent)...</p>
<pre><code class="language-bash">sudo apt install gcc gcc-arm-none-eabi python3 make
</code></pre>
<p>For Majaro and Arch Linux...</p>
<pre><code class="language-bash">sudo pacman -S arm-none-eabi-gcc
</code></pre>
</li>
<li>
<p>Install <code>rustup</code> with support for nightly target <code>thumbv7em-none-eabihf</code>. </p>
<p>Follow the instructions at https://rustup.rs/</p>
<p>Press Enter to select <code>1) Proceed with installation (default)</code></p>
<p>Then execute...</p>
<pre><code class="language-bash"># Latest nightly-2020-04-20 fails with asm error, so we use nightly-2020-02-16
source $HOME/.cargo/env
rustup default nightly-2020-02-16
rustup update
rustup target add thumbv7em-none-eabihf
</code></pre>
</li>
<li>
<p>Install the <code>newt</code> build tool for Mynewt.  Refer to these scripts...</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/install-version.sh"><code>scripts/install-version.sh</code></a>: To set the version numbers</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/install-pi.sh"><code>scripts/install-pi.sh</code></a>: To build and install <code>newt</code>, look under the section <code>&quot;Build newt&quot;</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="download-source-files" class="section-header"><a href="#download-source-files">11.2 Download Source Files</a></h2>
<ol>
<li>
<p>Download the source files to <code>~/pinetime</code>...</p>
<pre><code class="language-bash">mkdir ~/pinetime
cd ~/pinetime
git clone --recursive --branch master https://github.com/lupyuen/pinetime-rust-mynewt
</code></pre>
</li>
<li>
<p>Update the MCUBoot version number to 1.3.1. Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/project.yml"><code>~/pinetime/pinetime-rust-mynewt/project.yml</code></a></p>
<p>Change...</p>
<pre><code class="language-yaml">repository.mcuboot:
    type: github
    vers: 1.5.0
</code></pre>
<p>to...</p>
<pre><code class="language-yaml">repository.mcuboot:
    type: github
    vers: 1.3.1
</code></pre>
</li>
<li>
<p>Download the source code for Mynewt, NimBLE and MCUBoot...</p>
<pre><code class="language-bash">cd ~/pinetime/pinetime-rust-mynewt
newt install
</code></pre>
<p>We should see...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Downloading</span> <span class="ident">repository</span> <span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span> (<span class="ident">commit</span>: <span class="ident">master</span>) <span class="ident">from</span> <span class="ident">https</span>:<span class="comment">//github.com/apache/mynewt-core.git</span>
<span class="ident">Downloading</span> <span class="ident">repository</span> <span class="ident">mynewt</span><span class="op">-</span><span class="ident">mcumgr</span> (<span class="ident">commit</span>: <span class="ident">master</span>) <span class="ident">from</span> <span class="ident">https</span>:<span class="comment">//github.com/apache/mynewt-mcumgr.git</span>
<span class="ident">Downloading</span> <span class="ident">repository</span> <span class="ident">mynewt</span><span class="op">-</span><span class="ident">nimble</span> (<span class="ident">commit</span>: <span class="ident">master</span>) <span class="ident">from</span> <span class="ident">https</span>:<span class="comment">//github.com/apache/mynewt-nimble.git</span>
<span class="ident">Downloading</span> <span class="ident">repository</span> <span class="ident">mcuboot</span> (<span class="ident">commit</span>: <span class="ident">master</span>) <span class="ident">from</span> <span class="ident">https</span>:<span class="comment">//github.com/JuulLabs-OSS/mcuboot.git</span>
<span class="ident">Making</span> <span class="ident">the</span> <span class="ident">following</span> <span class="ident">changes</span> <span class="ident">to</span> <span class="ident">the</span> <span class="ident">project</span>:
    <span class="ident">install</span> <span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span> (<span class="number">1.7</span>.<span class="number">0</span>)
    <span class="ident">install</span> <span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">nimble</span> (<span class="number">1.2</span>.<span class="number">0</span>)
    <span class="ident">install</span> <span class="ident">mcuboot</span> (<span class="number">1.3</span>.<span class="number">1</span>)
<span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span> <span class="ident">successfully</span> <span class="ident">installed</span> <span class="ident">version</span> <span class="number">1.7</span>.<span class="number">0</span>
<span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">nimble</span> <span class="ident">successfully</span> <span class="ident">installed</span> <span class="ident">version</span> <span class="number">1.2</span>.<span class="number">0</span>
<span class="ident">Error</span>: <span class="ident">Error</span> <span class="ident">updating</span> <span class="string">&quot;mcuboot&quot;</span>: <span class="ident">error</span>: <span class="ident">The</span> <span class="ident">following</span> <span class="ident">untracked</span> <span class="ident">working</span> <span class="ident">tree</span> <span class="ident">files</span> <span class="ident">would</span> <span class="ident">be</span> <span class="ident">overwritten</span> <span class="ident">by</span> <span class="ident">checkout</span>:
        <span class="ident">ext</span><span class="op">/</span><span class="ident">mbedtls</span><span class="op">/</span><span class="ident">include</span><span class="op">/</span><span class="ident">mbedtls</span><span class="op">/</span><span class="ident">check_config</span>.<span class="ident">h</span>
        <span class="ident">ext</span><span class="op">/</span><span class="ident">mbedtls</span><span class="op">/</span><span class="ident">include</span><span class="op">/</span><span class="ident">mbedtls</span><span class="op">/</span><span class="ident">config</span>.<span class="ident">h</span>
<span class="ident">Please</span> <span class="kw">move</span> <span class="ident">or</span> <span class="ident">remove</span> <span class="ident">them</span> <span class="ident">before</span> <span class="ident">you</span> <span class="ident">switch</span> <span class="ident">branches</span>.
<span class="ident">Aborting</span></pre></div>
<p>Ignore the <code>mcuboot</code> error above and proceed to the next step.</p>
</li>
<li>
<p>Restore the MCUBoot version number to 1.5.0. Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/project.yml"><code>~/pinetime/pinetime-rust-mynewt/project.yml</code></a></p>
<p>Change...</p>
<pre><code class="language-yaml">repository.mcuboot:
    type: github
    vers: 1.3.1
</code></pre>
<p>to...</p>
<pre><code class="language-yaml">repository.mcuboot:
    type: github
    vers: 1.5.0
</code></pre>
</li>
<li>
<p>Download version 1.5.0 of MCUBoot to <code>repos/mcuboot</code></p>
<pre><code class="language-bash">cd ~/pinetime/pinetime-rust-mynewt/repos
rm -rf mcuboot
git clone --recursive --branch v1.5.0 https://github.com/JuulLabs-OSS/mcuboot
</code></pre>
</li>
</ol>
<p>Why are we doing this? Because we are using a more recent version of MCUBoot (1.5.0), but that's not in sync with the older Mynewt version (1.7.0). This will cause <code>newt install</code> to fail. Hence we do this workaround to force Mynewt to build with the newer MCUBoot.</p>
<h2 id="build-mcuboot-bootloader" class="section-header"><a href="#build-mcuboot-bootloader">11.3 Build MCUBoot Bootloader</a></h2>
<p>Build the MCUBoot Bootloader...</p>
<pre><code class="language-bash">cd ~/pinetime/pinetime-rust-mynewt
scripts/nrf52/build-boot.sh
</code></pre>
<p>We should see...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Linking</span> <span class="ident">pinetime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_boot</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">boot</span><span class="op">/</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">mynewt</span>.<span class="ident">elf</span>
<span class="ident">Target</span> <span class="ident">successfully</span> <span class="ident">built</span>: <span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_boot</span>
<span class="op">+</span> <span class="ident">newt</span> <span class="ident">size</span> <span class="op">-</span><span class="ident">v</span> <span class="ident">nrf52_boot</span>
<span class="ident">Size</span> <span class="ident">of</span> <span class="ident">Application</span> <span class="ident">Image</span>: <span class="ident">app</span>
<span class="ident">Mem</span> <span class="ident">FLASH</span>: <span class="number">0x0</span><span class="op">-</span><span class="number">0x6000</span>
<span class="ident">Mem</span> <span class="ident">RAM</span>: <span class="number">0x20000000</span><span class="op">-</span><span class="number">0x20010000</span>
  <span class="ident">FLASH</span>     <span class="ident">RAM</span> 
     <span class="number">90</span>     <span class="number">229</span> <span class="kw-2">*</span><span class="ident">fill</span><span class="op">*</span>
   <span class="number">6823</span>    <span class="number">5996</span> <span class="ident">boot_bootutil</span>.<span class="ident">a</span>
    <span class="number">124</span>       <span class="number">0</span> <span class="ident">boot_mynewt</span>.<span class="ident">a</span>
     <span class="number">18</span>       <span class="number">0</span> <span class="ident">boot_mynewt_flash_map_backend</span>.<span class="ident">a</span>
   <span class="number">1182</span>       <span class="number">0</span> <span class="ident">crypto_mbedtls</span>.<span class="ident">a</span>
    <span class="number">392</span>     <span class="number">444</span> <span class="ident">hw_bsp_nrf52</span>.<span class="ident">a</span>
     <span class="number">52</span>       <span class="number">0</span> <span class="ident">hw_cmsis</span><span class="op">-</span><span class="ident">core</span>.<span class="ident">a</span>
   <span class="number">1280</span>      <span class="number">80</span> <span class="ident">hw_drivers_flash_spiflash</span>.<span class="ident">a</span>
    <span class="number">654</span>       <span class="number">1</span> <span class="ident">hw_hal</span>.<span class="ident">a</span>
   <span class="number">4192</span>      <span class="number">72</span> <span class="ident">hw_mcu_nordic_nrf52xxx</span>.<span class="ident">a</span>
   <span class="number">2006</span>   <span class="number">18776</span> <span class="ident">kernel_os</span>.<span class="ident">a</span>
   <span class="number">1930</span>      <span class="number">12</span> <span class="ident">libc_baselibc</span>.<span class="ident">a</span>
   <span class="number">1478</span>     <span class="number">256</span> <span class="ident">libs_pinetime_boot</span>.<span class="ident">a</span>
    <span class="number">529</span>      <span class="number">40</span> <span class="ident">libs_semihosting_console</span>.<span class="ident">a</span>
    <span class="number">544</span>     <span class="number">128</span> <span class="ident">sys_flash_map</span>.<span class="ident">a</span>
      <span class="number">2</span>       <span class="number">0</span> <span class="ident">sys_log_modlog</span>.<span class="ident">a</span>
    <span class="number">632</span>      <span class="number">29</span> <span class="ident">sys_mfg</span>.<span class="ident">a</span>
     <span class="number">30</span>       <span class="number">5</span> <span class="ident">sys_sysinit</span>.<span class="ident">a</span>
     <span class="number">48</span>       <span class="number">0</span> <span class="ident">util_mem</span>.<span class="ident">a</span>
    <span class="number">100</span>       <span class="number">0</span> <span class="ident">nrf52_boot</span><span class="op">-</span><span class="ident">sysinit</span><span class="op">-</span><span class="ident">app</span>.<span class="ident">a</span>
    <span class="number">756</span>       <span class="number">0</span> <span class="ident">libgcc</span>.<span class="ident">a</span>
<span class="ident">Loading</span> <span class="ident">compiler</span> <span class="ident">pinetime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">repos</span><span class="op">/</span><span class="ident">apache</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">-</span><span class="ident">core</span><span class="op">/</span><span class="ident">compiler</span><span class="op">/</span><span class="ident">arm</span><span class="op">-</span><span class="ident">none</span><span class="op">-</span><span class="ident">eabi</span><span class="op">-</span><span class="ident">m4</span>, <span class="ident">buildProfile</span> <span class="ident">debug</span>

<span class="ident">objsize</span>
   <span class="ident">text</span>    <span class="ident">data</span>     <span class="ident">bss</span>     <span class="ident">dec</span>     <span class="ident">hex</span> <span class="ident">filename</span>
  <span class="number">22792</span>     <span class="number">132</span>   <span class="number">25504</span>   <span class="number">48428</span>    <span class="ident">bd2c</span> <span class="ident">pinetime</span><span class="op">/</span><span class="ident">pinetime</span><span class="op">-</span><span class="ident">rust</span><span class="op">-</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_boot</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">boot</span><span class="op">/</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">mynewt</span>.<span class="ident">elf</span></pre></div>
<h2 id="select-the-openocd-interface-st-link-or-raspberry-pi-spi" class="section-header"><a href="#select-the-openocd-interface-st-link-or-raspberry-pi-spi">11.4 Select the OpenOCD Interface: ST-Link or Raspberry Pi SPI</a></h2>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/config.sh"><code>~/pinetime/pinetime-rust-mynewt/scripts/config.sh</code></a></p>
<p>If we're using ST-Link v2 for flashing PineTime, set <code>swd_device</code> as follows...</p>
<pre><code class="language-bash">#  Select ST-Link v2 as SWD Programmer
swd_device=scripts/nrf52/swd-stlink.ocd
</code></pre>
<p>If we're using <a href="https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590?source=friends_link&amp;sk=df399bfd913d3e262447d28aa5af6b63">Raspberry Pi SPI</a> for flashing PineTime, set <code>swd_device</code> as follows...</p>
<pre><code class="language-bash">#  Select Raspberry Pi as SWD Programmer
swd_device=scripts/nrf52-pi/swd-pi.ocd
</code></pre>
<h2 id="flash-mcuboot-bootloader" class="section-header"><a href="#flash-mcuboot-bootloader">11.5 Flash MCUBoot Bootloader</a></h2>
<ol>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-boot.sh"><code>~/pinetime/pinetime-rust-mynewt/scripts/nrf52/flash-boot.sh</code></a></p>
</li>
<li>
<p>Change <code>openocd/bin/openocd</code> to the path of our installed <code>openocd</code> (for ST-Link) or <code>openocd-spi</code> (for Raspberry Pi)...</p>
<pre><code class="language-bash">#  Flash the device
openocd/bin/openocd \
    -f $swd_device \
    -f scripts/nrf52/flash-boot.ocd
</code></pre>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-boot.ocd"><code>~/pinetime/pinetime-rust-mynewt/scripts/nrf52/flash-boot.ocd</code></a></p>
</li>
<li>
<p>The path of the built firmware file is defined in <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-boot.ocd"><code>~/pinetime/pinetime-rust-mynewt/scripts/nrf52/flash-boot.ocd</code></a>. We shouldn't need to change this.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">program</span> <span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_boot</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">boot</span><span class="op">/</span><span class="ident">mynewt</span><span class="op">/</span><span class="ident">mynewt</span>.<span class="ident">elf</span>.<span class="ident">bin</span> <span class="ident">verify</span> <span class="number">0x00000000</span></pre></div>
</li>
<li>
<p>Flash the bootloader...</p>
<pre><code class="language-bash">scripts/nrf52/flash-boot.sh
</code></pre>
</li>
<li>
<p>We should see...</p>

<pre><code>&gt; Executing task in folder pinetime-rust-mynewt: bash -c -l &#39; scripts/nrf52/flash-boot.sh &amp;&amp; echo ✅ ◾ ️Done! &#39; &lt;

+ source scripts/config.sh
++ swd_device=scripts/nrf52/swd-stlink.ocd
+ openocd/bin/openocd -f scripts/nrf52/swd-stlink.ocd -f scripts/nrf52/flash-boot.ocd
GNU MCU Eclipse 64-bit Open On-Chip Debugger 0.10.0+dev-00462-gdd1d90111 (2019-01-15-13:49)
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
debug_level: 0
adapter speed: 1000 kHz
force hard breakpoints
Stopping...
target halted due to breakpoint, current mode: Thread 
xPSR: 0x21000000 pc: 0x000023a4 msp: 0x2000ff9c

Flashing Bootloader...
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x000000d8 msp: 0x20010000
Enabled ARM Semihosting to show debug output
semihosting is enabled
** Programming Started **
auto erase enabled
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000001e msp: 0x20010000, semihosting
wrote 24576 bytes from file bin/targets/nrf52_boot/app/boot/mynewt/mynewt.elf.bin in 0.729124s (32.916 KiB/s)
** Programming Finished **
** Verify Started **
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000002e msp: 0x20010000, semihosting
verified 22876 bytes in 0.114145s (195.715 KiB/s)
** Verified OK **

Restarting...
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x000000d8 msp: 0x20010000, semihosting

**** Done!</code></pre></li>
<li>
<p>For ST-Link, check that the Adapter Speed is set to 1000 kHz. OpenOCD won't work at higher speeds.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">adapter</span> <span class="ident">speed</span>: <span class="number">1000</span> <span class="ident">kHz</span></pre></div>
</li>
<li>
<p>If the flashing fails, check whether any <code>openocd</code> processes are running in the background, and kill them.</p>
</li>
<li>
<p>Alternatively, use <a href="https://github.com/lupyuen/pinetime-updater/blob/master/README.md"><strong>PineTime Updater</strong></a> to flash the bootloader...</p>
<ul>
<li>
<p>Select <code>Downloaded File</code></p>
</li>
<li>
<p>Select the file <code>bin/targets/nrf52_boot/app/boot/mynewt/mynewt.elf.bin</code></p>
</li>
<li>
<p>Enter address <code>0x0</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="flash-application-firmware" class="section-header"><a href="#flash-application-firmware">11.6 Flash Application Firmware</a></h2>
<ol>
<li>
<p>Download one of the following Application Firmware Images...</p>
<ul>
<li>
<p>Mynewt: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/download/v4.1.1/my_sensor_app.img"><code>my_sensor_app.img</code></a></p>
</li>
<li>
<p>FreeRTOS: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/download/v4.1.5/jf.bin"><code>jf.bin</code></a></p>
</li>
</ul>
<p>For other versions of the Application Firmware Image, <a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">see this article</a></p>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-app.sh"><code>~/pinetime/pinetime-rust-mynewt/scripts/nrf52/flash-app.sh</code></a></p>
</li>
<li>
<p>Change <code>openocd/bin/openocd</code> to the path of our installed <code>openocd</code> (for ST-Link) or <code>openocd-spi</code> (for Raspberry Pi)...</p>
<pre><code class="language-bash">#  Flash the device
openocd/bin/openocd \
    -f $swd_device \
    -f scripts/nrf52/flash-app.ocd
</code></pre>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-app.ocd"><code>~/pinetime/pinetime-rust-mynewt/scripts/nrf52/flash-app.ocd</code></a></p>
</li>
<li>
<p>Change <code>bin/targets/nrf52_my_sensor/app/apps/my_sensor_app/my_sensor_app.img</code> to the path of the downloaded Application Firmware Image File...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">program</span> <span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">apps</span><span class="op">/</span><span class="ident">my_sensor_app</span><span class="op">/</span><span class="ident">my_sensor_app</span>.<span class="ident">img</span> <span class="ident">verify</span> <span class="number">0x00008000</span></pre></div>
</li>
<li>
<p>Flash the application...</p>
<pre><code class="language-bash">scripts/nrf52/flash-app.sh
</code></pre>
</li>
<li>
<p>We should see...</p>

<pre><code>&gt; Executing task in folder pinetime-rust-mynewt: bash -c -l &#39; scripts/nrf52/flash-app.sh &amp;&amp; echo ✅ ◾ ️Done! &#39; &lt;

+ source scripts/config.sh
++ swd_device=scripts/nrf52/swd-stlink.ocd
+ openocd/bin/openocd -f scripts/nrf52/swd-stlink.ocd -f scripts/nrf52/flash-app.ocd
GNU MCU Eclipse 64-bit Open On-Chip Debugger 0.10.0+dev-00462-gdd1d90111 (2019-01-15-13:49)
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
debug_level: 0
adapter speed: 1000 kHz
force hard breakpoints
Stopping...
target halted due to debug-request, current mode: Thread 
xPSR: 0x61000000 pc: 0x000001ca msp: 0x2000ffd8

Flashing Application...
target halted due to debug-request, current mode: Thread 
xPSR: 0x01000000 pc: 0x000000d8 msp: 0x20010000
Enabled ARM Semihosting to show debug output
semihosting is enabled
** Programming Started **
auto erase enabled
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000001e msp: 0x20010000, semihosting
wrote 143360 bytes from file bin/targets/nrf52_my_sensor/app/apps/my_sensor_app/my_sensor_app.img in 3.606276s (38.821 KiB/s)
** Programming Finished **
** Verify Started **
target halted due to breakpoint, current mode: Thread 
xPSR: 0x61000000 pc: 0x2000002e msp: 0x20010000, semihosting
verified 139268 bytes in 0.363909s (373.731 KiB/s)
** Verified OK **</code></pre></li>
<li>
<p>For ST-Link, check that the Adapter Speed is set to 1000 kHz. OpenOCD won't work at higher speeds.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">adapter</span> <span class="ident">speed</span>: <span class="number">1000</span> <span class="ident">kHz</span></pre></div>
</li>
<li>
<p>If the flashing fails, check whether any <code>openocd</code> processes are running in the background, and kill them.</p>
</li>
<li>
<p>PineTime reboots (with the <code>reset init</code> OpenOCD Command)...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Restarting</span>...
<span class="ident">target</span> <span class="ident">halted</span> <span class="ident">due</span> <span class="ident">to</span> <span class="ident">debug</span><span class="op">-</span><span class="ident">request</span>, <span class="ident">current</span> <span class="ident">mode</span>: <span class="ident">Thread</span> 
<span class="ident">xPSR</span>: <span class="number">0x01000000</span> <span class="ident">pc</span>: <span class="number">0x000000d8</span> <span class="ident">msp</span>: <span class="number">0x20010000</span>, <span class="ident">semihosting</span>
<span class="ident">Enabled</span> <span class="ident">ARM</span> <span class="ident">Semihosting</span> <span class="ident">to</span> <span class="ident">show</span> <span class="ident">debug</span> <span class="ident">output</span>
<span class="ident">semihosting</span> <span class="ident">is</span> <span class="ident">enabled</span></pre></div>
</li>
<li>
<p>PineTime starts MCUBoot Bootloader...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw-2">*</span><span class="kw-2">*</span><span class="kw-2">*</span><span class="op">*</span> <span class="macro">Done</span><span class="macro">!</span> <span class="ident">Press</span> <span class="ident">Ctrl</span><span class="op">-</span><span class="ident">C</span> <span class="ident">to</span> <span class="ident">exit</span>...
<span class="ident">Starting</span> <span class="ident">Bootloader</span>...
<span class="ident">Displaying</span> <span class="ident">image</span>...
<span class="ident">Image</span> <span class="ident">displayed</span>
<span class="ident">Check</span> <span class="ident">button</span>: <span class="number">0</span>
[<span class="ident">INF</span>] <span class="ident">Primary</span> <span class="ident">image</span>: <span class="ident">magic</span><span class="op">=</span><span class="ident">good</span>, <span class="ident">swap_type</span><span class="op">=</span><span class="number">0x4</span>, <span class="ident">copy_done</span><span class="op">=</span><span class="number">0x1</span>, <span class="ident">image_ok</span><span class="op">=</span><span class="number">0x1</span>
[<span class="ident">INF</span>] <span class="ident">Scratch</span>: <span class="ident">magic</span><span class="op">=</span><span class="ident">bad</span>, <span class="ident">swap_type</span><span class="op">=</span><span class="number">0x1</span>, <span class="ident">copy_done</span><span class="op">=</span><span class="number">0x2</span>, <span class="ident">image_ok</span><span class="op">=</span><span class="number">0x2</span>
[<span class="ident">INF</span>] <span class="ident">Boot</span> <span class="ident">source</span>: <span class="ident">none</span>
[<span class="ident">INF</span>] <span class="ident">Swap</span> <span class="kw">type</span>: <span class="ident">none</span>
<span class="ident">Waiting</span> <span class="number">5</span> <span class="ident">seconds</span> <span class="kw">for</span> <span class="ident">button</span>...
<span class="ident">Waited</span> <span class="kw">for</span> <span class="ident">button</span>: <span class="number">0</span>
<span class="ident">Bootloader</span> <span class="ident">done</span></pre></div>
</li>
<li>
<p>Finally PineTime starts the Application Firmware...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">TMP</span> <span class="ident">create</span> <span class="ident">temp_stub_0</span>
<span class="ident">NET</span> <span class="ident">hwid</span> <span class="number">4a</span> <span class="ident">f8</span> <span class="ident">cf</span> <span class="number">95</span> <span class="number">6a</span> <span class="ident">be</span> <span class="ident">c1</span> <span class="ident">f6</span> <span class="number">89</span> <span class="ident">ba</span> <span class="number">12</span> <span class="number">1a</span> 
<span class="ident">NET</span> <span class="ident">standalone</span> <span class="ident">node</span> </pre></div>
</li>
<li>
<p>Firmware tests internal and external flash memory...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Testing</span> <span class="ident">flash</span>...
<span class="ident">Read</span> <span class="ident">Internal</span> <span class="ident">Flash</span> <span class="ident">ROM</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
<span class="number">0x0000</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x20</span> <span class="number">0xd9</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="number">0x0008</span>: <span class="number">0x35</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x37</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="number">0x0010</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Read</span> <span class="ident">External</span> <span class="ident">SPI</span> <span class="ident">Flash</span>...
<span class="ident">Read</span> <span class="number">0x0</span> <span class="op">+</span> <span class="number">20</span>
<span class="number">0x0000</span>: <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0xf0</span> <span class="number">0x0f</span> <span class="number">0xff</span> <span class="number">0xf7</span> 
<span class="number">0x0008</span>: <span class="number">0x6c</span> <span class="number">0x69</span> <span class="number">0x74</span> <span class="number">0x74</span> <span class="number">0x6c</span> <span class="number">0x65</span> <span class="number">0x66</span> <span class="number">0x73</span> 
<span class="number">0x0010</span>: <span class="number">0x2f</span> <span class="number">0xe0</span> <span class="number">0x00</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00</span> 
<span class="number">0x0018</span>: <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> 
<span class="ident">Flash</span> <span class="ident">OK</span></pre></div>
</li>
<li>
<p>When we connect with <code>newtmgr</code>, the Bluetooth LE events are shown...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Starting</span> <span class="ident">BLE</span>...
<span class="ident">BLE</span> <span class="ident">started</span>
<span class="ident">Rust</span> <span class="ident">test</span> <span class="ident">display</span> <span class="number">1.0</span>.<span class="number">0</span>
<span class="ident">Rust</span> <span class="ident">touch</span> <span class="ident">sensor</span>
<span class="ident">connection</span> <span class="ident">established</span>; <span class="ident">status</span><span class="op">=</span><span class="number">0</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span>

<span class="ident">mtu</span> <span class="ident">update</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">cid</span><span class="op">=</span><span class="number">4</span> <span class="ident">mtu</span><span class="op">=</span><span class="number">256</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">1</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">0</span> <span class="ident">curn</span><span class="op">=</span><span class="number">1</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">2</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">1</span> <span class="ident">curn</span><span class="op">=</span><span class="number">0</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">disconnect</span>; <span class="ident">reason</span><span class="op">=</span><span class="number">531</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span>

<span class="ident">connection</span> <span class="ident">established</span>; <span class="ident">status</span><span class="op">=</span><span class="number">0</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span>

<span class="ident">mtu</span> <span class="ident">update</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">cid</span><span class="op">=</span><span class="number">4</span> <span class="ident">mtu</span><span class="op">=</span><span class="number">256</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">1</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">0</span> <span class="ident">curn</span><span class="op">=</span><span class="number">1</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">2</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">1</span> <span class="ident">curn</span><span class="op">=</span><span class="number">0</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">disconnect</span>; <span class="ident">reason</span><span class="op">=</span><span class="number">531</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span>

<span class="ident">connection</span> <span class="ident">established</span>; <span class="ident">status</span><span class="op">=</span><span class="number">0</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span>

<span class="ident">mtu</span> <span class="ident">update</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">cid</span><span class="op">=</span><span class="number">4</span> <span class="ident">mtu</span><span class="op">=</span><span class="number">256</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">1</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">0</span> <span class="ident">curn</span><span class="op">=</span><span class="number">1</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">subscribe</span> <span class="ident">event</span>; <span class="ident">conn_handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">attr_handle</span><span class="op">=</span><span class="number">30</span> <span class="ident">reason</span><span class="op">=</span><span class="number">2</span> <span class="ident">prevn</span><span class="op">=</span><span class="number">1</span> <span class="ident">curn</span><span class="op">=</span><span class="number">0</span> <span class="ident">previ</span><span class="op">=</span><span class="number">0</span> <span class="ident">curi</span><span class="op">=</span><span class="number">0</span>
<span class="ident">disconnect</span>; <span class="ident">reason</span><span class="op">=</span><span class="number">531</span> <span class="ident">handle</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_ota_addr</span><span class="op">=</span> <span class="ident">our_id_addr_type</span><span class="op">=</span><span class="number">1</span> <span class="ident">our_id_addr</span><span class="op">=</span> <span class="ident">peer_ota_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_ota_addr</span><span class="op">=</span> <span class="ident">peer_id_addr_type</span><span class="op">=</span><span class="number">0</span> <span class="ident">peer_id_addr</span><span class="op">=</span> <span class="ident">conn_itvl</span><span class="op">=</span><span class="number">6</span> <span class="ident">conn_latency</span><span class="op">=</span><span class="number">0</span> <span class="ident">supervision_timeout</span><span class="op">=</span><span class="number">72</span> <span class="ident">encrypted</span><span class="op">=</span><span class="number">0</span> <span class="ident">authenticated</span><span class="op">=</span><span class="number">0</span> <span class="ident">bonded</span><span class="op">=</span><span class="number">0</span></pre></div>
</li>
<li>
<p>Alternatively, use <a href="https://github.com/lupyuen/pinetime-updater/blob/master/README.md"><strong>PineTime Updater</strong></a> to flash the Application Firmware...</p>
<ul>
<li>
<p>Select <code>Downloaded File</code></p>
</li>
<li>
<p>Enter the path of the downloaded Application Firmware Image File</p>
</li>
<li>
<p>Enter address <code>0x8000</code></p>
</li>
</ul>
</li>
</ol>
<h1 id="further-reading" class="section-header"><a href="#further-reading">12 Further Reading</a></h1>
<p>[ UPDATE: <a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">Check out the testing of Wireless Firmware Updates on PineTime</a> ]</p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>

    
</body>
</html>